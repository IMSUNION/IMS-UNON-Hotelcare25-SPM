<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IMS 'UNION_Hotelcare25</title>
    <meta name="description" content="í˜¸í…” ë§¤ì¶œ ì„±ê³¼ ê´€ë¦¬ ë° AI ë¶„ì„ ì‹œìŠ¤í…œ - í´ë¼ìš°ë“œ ë²„ì „">
    <meta name="theme-color" content="#2E4052">
    <link rel="icon" href="https://i.ibb.co/QGstQ2G/favicon-16x16.png">
    <link rel="apple-touch-icon" href="https://i.ibb.co/QGstQ2G/favicon-16x16.png">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <!-- Chart.js, Lucide Icons, SheetJS -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    
    <style>
        :root {
            --primary: #36B8ED;
            --primary-dark: #2A9BC7;
            --accent: #FF5757;
            --dark: #2E4052;
            --dark-light: #3D536A;
            --bg-light: #F4F7F9;
            --white: #ffffff;
            --gray-100: #f8f9fa;
            --gray-200: #e9ecef;
            --gray-300: #dee2e6;
            --text-main: #333333;
            --text-muted: #6c757d;
            --radius: 12px;
            --shadow: 0 4px 15px rgba(0,0,0,0.05);
            --sidebar-width: 260px;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, 'Segoe UI', sans-serif; }
        body { background-color: var(--bg-light); color: var(--text-main); display: flex; min-height: 100vh; overflow-x: hidden; }
        
        /* ========== ì¸ì¦ í™”ë©´ ìŠ¤íƒ€ì¼ ========== */
        .auth-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(135deg, var(--dark) 0%, var(--dark-light) 100%);
            z-index: 10000; display: flex; justify-content: center; align-items: center;
            transition: opacity 0.3s, visibility 0.3s;
        }
        .auth-overlay.hidden { opacity: 0; visibility: hidden; pointer-events: none; }
        
        .auth-container {
            background: var(--white); border-radius: 20px; padding: 40px; width: 100%; max-width: 440px;
            box-shadow: 0 25px 80px rgba(0,0,0,0.4); animation: authSlideUp 0.4s ease;
        }
        @keyframes authSlideUp { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .auth-logo { text-align: center; margin-bottom: 30px; }
        .auth-logo img { max-width: 100px; width: auto; height: auto; display: block; margin: 0 auto 4px auto; }
        .auth-logo h1 { font-size: 1.6rem; color: var(--dark); margin-bottom: 5px; margin-top: 0; font-weight: 700; padding-top: 0; }
        .auth-logo p { color: var(--text-muted); font-size: 0.9rem; margin-top: 4px; }
        
        .auth-tabs { display: flex; margin-bottom: 25px; border-bottom: 2px solid var(--gray-200); }
        .auth-tab { flex: 1; padding: 12px; text-align: center; cursor: pointer; font-weight: 600; color: var(--text-muted); border-bottom: 3px solid transparent; margin-bottom: -2px; transition: all 0.2s; }
        .auth-tab:hover { color: var(--primary); }
        .auth-tab.active { color: var(--primary); border-bottom-color: var(--primary); }
        
        .auth-form { display: none; }
        .auth-form.active { display: block; }
        .auth-form .form-group { margin-bottom: 16px; }
        .auth-form label { display: block; font-size: 0.85rem; font-weight: 600; margin-bottom: 6px; color: var(--dark); }
        .auth-form input, .auth-form select { width: 100%; padding: 12px 15px; border: 2px solid var(--gray-200); border-radius: 10px; font-size: 0.95rem; transition: all 0.2s; }
        .auth-form input:focus, .auth-form select:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 3px rgba(54,184,237,0.15); }
        
        .auth-btn { width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 10px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.2s; margin-top: 10px; }
        .auth-btn:hover { background: var(--primary-dark); transform: translateY(-1px); }
        .auth-btn:disabled { background: var(--gray-300); cursor: not-allowed; }
        
        .auth-error { background: rgba(239,68,68,0.1); color: var(--danger); padding: 12px; border-radius: 8px; margin-bottom: 15px; font-size: 0.85rem; display: none; }
        .auth-error.show { display: block; }
        
        .auth-info { background: rgba(54,184,237,0.1); border-radius: 10px; padding: 14px; margin-bottom: 18px; font-size: 0.85rem; line-height: 1.5; }
        .auth-info strong { color: var(--primary); }
        
        .auth-divider { text-align: center; margin: 20px 0; color: var(--text-muted); font-size: 0.8rem; }
        
        /* ========== í…Œë„ŒíŠ¸ ë°°ì§€ ========== */
        .tenant-badge {
            background: linear-gradient(135deg, rgba(54,184,237,0.2), rgba(54,184,237,0.1));
            border-radius: 10px; padding: 14px; margin-bottom: 20px; border: 1px solid rgba(54,184,237,0.3);
        }
        .tenant-badge .tenant-name { font-weight: 700; font-size: 0.95rem; color: white; margin-bottom: 5px; display: flex; align-items: center; gap: 6px; }
        .tenant-badge .user-info { font-size: 0.75rem; color: rgba(255,255,255,0.7); margin-bottom: 6px; word-break: break-all; }
        .tenant-badge .user-role { display: inline-block; font-size: 0.65rem; padding: 3px 10px; background: var(--primary); border-radius: 12px; color: white; font-weight: 600; }
        
        /* ========== ë™ê¸°í™” ìƒíƒœ ========== */
        .sync-indicator { display: flex; align-items: center; gap: 8px; padding: 10px 14px; background: rgba(255,255,255,0.05); border-radius: 8px; margin-top: auto; margin-bottom: 10px; }
        .sync-dot { width: 8px; height: 8px; border-radius: 50%; }
        .sync-indicator.synced .sync-dot { background: var(--success); }
        .sync-indicator.syncing .sync-dot { background: var(--warning); animation: pulse 1s infinite; }
        .sync-indicator.offline .sync-dot { background: var(--danger); }
        .sync-indicator span { font-size: 0.75rem; color: rgba(255,255,255,0.6); }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
        
        /* ========== ë¡œë”© ì˜¤ë²„ë ˆì´ ========== */
        .loading-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,255,255,0.95); z-index: 9999;
            display: none; justify-content: center; align-items: center; flex-direction: column; gap: 15px;
        }
        .loading-overlay.active { display: flex; }
        .spinner { width: 45px; height: 45px; border: 4px solid var(--gray-200); border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* ========== ì‚¬ì´ë“œë°” ========== */
        #sidebar {
            width: var(--sidebar-width); background: var(--dark); color: white; padding: 20px; padding-bottom: 20px;
            display: flex; flex-direction: column; position: fixed; height: 100vh; z-index: 100;
            transition: all 0.3s ease; box-shadow: 2px 0 10px rgba(0,0,0,0.1); overflow-y: auto;
        }
        #sidebar.hidden { transform: translateX(-100%); }
        
        .brand { display: flex; align-items: center; gap: 12px; padding: 10px 0 20px; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 15px; }
        .brand img { height: 32px; filter: brightness(0) invert(1); }
        .brand span { font-weight: 700; font-size: 1.1rem; letter-spacing: -0.5px; color: white; }
        
        .nav-menu { flex: 1; list-style: none; }
        .nav-item { display: flex; align-items: center; gap: 12px; padding: 12px 16px; border-radius: var(--radius); cursor: pointer; transition: 0.2s; margin-bottom: 4px; color: rgba(255,255,255,0.7); font-size: 0.9rem; }
        .nav-item:hover { background: rgba(255,255,255,0.1); color: var(--primary); }
        .nav-item.active { font-weight: 600; color: white; background: var(--primary); }
        .nav-item i { width: 20px; height: 20px; }
        
        .sidebar-footer { padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.1); }
        .logout-btn { display: flex; align-items: center; gap: 10px; padding: 12px 16px; border-radius: var(--radius); cursor: pointer; color: rgba(255,255,255,0.6); font-size: 0.85rem; transition: all 0.2s; }
        .logout-btn:hover { background: rgba(239,68,68,0.2); color: var(--accent); }
        
        /* ========== ë©”ì¸ ì½˜í…ì¸  ========== */
        #main-content {
            margin-left: var(--sidebar-width); flex: 1; padding: 30px; padding-bottom: 80px;
            max-width: calc(100vw - var(--sidebar-width)); transition: margin-left 0.3s ease; min-height: 100vh;
        }
        #main-content.full-width { margin-left: 0; max-width: 100vw; }
        
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        header h2 { font-size: 1.8rem; font-weight: 700; color: var(--dark); }
        .toggle-fullscreen-btn { background: var(--gray-200); border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 0.9rem; display: flex; align-items: center; gap: 6px; }
        .toggle-fullscreen-btn:hover { background: var(--gray-300); }
        .user-profile { display: flex; align-items: center; gap: 15px; }
        .alert-badge { position: relative; cursor: pointer; padding: 8px; border-radius: 8px; transition: 0.2s; }
        .alert-badge:hover { background: var(--gray-100); }
        .badge-dot { position: absolute; top: 4px; right: 4px; width: 8px; height: 8px; background: var(--accent); border-radius: 50%; }
        
        /* ========== ì¹´ë“œ & í¼ ========== */
        .card { background: var(--white); border-radius: var(--radius); padding: 24px; box-shadow: var(--shadow); margin-bottom: 24px; }
        .section-title { font-size: 1.2rem; font-weight: 700; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; color: var(--dark); }
        .section-title i { width: 24px; height: 24px; color: var(--primary); }
        
        .grid-4 { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 24px; }
        .grid-3 { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; }
        .grid-2 { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 24px; }
        
        .stat-card { display: flex; flex-direction: column; gap: 8px; }
        .stat-label { font-size: 0.85rem; color: var(--text-muted); font-weight: 500; }
        .stat-value { font-size: 1.4rem; font-weight: 700; color: var(--dark); }
        .stat-change { font-size: 0.8rem; color: var(--text-muted); }
        .stat-change.positive { color: var(--success); }
        .stat-change.negative { color: var(--danger); }
        
        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 0.9rem; }
        input, select, textarea { width: 100%; padding: 10px 14px; border: 2px solid var(--gray-200); border-radius: 8px; font-size: 0.95rem; transition: all 0.2s; }
        input:focus, select:focus, textarea:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 3px rgba(54,184,237,0.15); }
        
        .btn { padding: 10px 20px; border-radius: 8px; font-weight: 600; font-size: 0.9rem; cursor: pointer; transition: all 0.2s; border: none; display: inline-flex; align-items: center; justify-content: center; gap: 6px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-secondary { background: var(--gray-200); color: var(--dark); }
        .btn-secondary:hover { background: var(--gray-300); }
        .btn-danger { background: var(--danger); color: white; }
        .btn-danger:hover { background: #dc2626; }
        .btn-success { background: var(--success); color: white; }
        
        /* ========== í…Œì´ë¸” ========== */
        .table-responsive { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid var(--gray-200); }
        th { background: var(--gray-100); font-weight: 600; color: var(--dark); position: sticky; top: 0; }
        tr:hover { background: var(--gray-100); }
        
        /* ========== ì„¹ì…˜ & ëª¨ë‹¬ ========== */
        .content-section { display: none; animation: fadeIn 0.4s ease; }
        .content-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .custom-modal { display: none; position: fixed; z-index: 10000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(46,64,82,0.7); backdrop-filter: blur(5px); align-items: center; justify-content: center; }
        .custom-modal.active { display: flex; }
        .custom-modal-content { background: var(--white); padding: 0; border-radius: 15px; max-width: 500px; width: 90%; max-height: 90vh; overflow: hidden; box-shadow: 0 10px 40px rgba(0,0,0,0.3); animation: modalSlideUp 0.3s; }
        @keyframes modalSlideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .custom-modal-header { background: linear-gradient(135deg, var(--primary), #2A9FD4); color: white; padding: 20px 25px; display: flex; justify-content: space-between; align-items: center; }
        .custom-modal-header h2 { margin: 0; font-size: 1.2rem; }
        .custom-modal-body { padding: 25px; max-height: 60vh; overflow-y: auto; }
        .custom-modal-footer { padding: 15px 25px; border-top: 1px solid var(--gray-200); display: flex; justify-content: flex-end; gap: 10px; }
        .modal-close { background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; }
        
        /* ========== ì•Œë¦¼ í† ìŠ¤íŠ¸ ========== */
        .toast-container { position: fixed; top: 20px; right: 20px; z-index: 10001; display: flex; flex-direction: column; gap: 10px; }
        .toast { padding: 14px 20px; border-radius: 10px; background: white; box-shadow: 0 4px 20px rgba(0,0,0,0.15); display: flex; align-items: center; gap: 10px; animation: toastIn 0.3s; min-width: 280px; }
        .toast.success { border-left: 4px solid var(--success); }
        .toast.error { border-left: 4px solid var(--danger); }
        .toast.warning { border-left: 4px solid var(--warning); }
        @keyframes toastIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        
        /* ========== íˆ´íŒ ========== */
        .term-explanation { cursor: help; display: inline-flex; align-items: center; justify-content: center; width: 18px; height: 18px; border-radius: 50%; background: var(--gray-200); color: var(--text-muted); font-size: 0.7rem; margin-left: 5px; position: relative; }
        .term-explanation:hover { background: var(--primary); color: white; }
        .term-explanation::after { content: attr(title); position: absolute; background: var(--dark); color: white; padding: 10px 14px; border-radius: 8px; font-size: 0.75rem; white-space: pre-line; max-width: 260px; opacity: 0; pointer-events: none; z-index: 1000; bottom: 100%; left: 50%; transform: translateX(-50%); margin-bottom: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); transition: opacity 0.2s; }
        .term-explanation:hover::after { opacity: 1; }
        
        /* ========== ë°˜ì‘í˜• ========== */
        @media (max-width: 1024px) {
            #sidebar { width: 80px; padding: 15px 10px; }
            .brand span, .nav-item span, .tenant-badge .user-info { display: none; }
            .tenant-badge .tenant-name { font-size: 0.7rem; justify-content: center; }
            .tenant-badge .user-role { display: none; }
            #main-content { margin-left: 80px; max-width: calc(100vw - 80px); padding: 20px; }
            .grid-4 { grid-template-columns: repeat(2, 1fr); }
        }
        @media (max-width: 768px) {
            #sidebar { transform: translateX(-100%); width: var(--sidebar-width); }
            #sidebar.mobile-open { transform: translateX(0); }
            #main-content { margin-left: 0; max-width: 100vw; padding: 15px; }
            .grid-4, .grid-2, .grid-3 { grid-template-columns: 1fr; }
            header h2 { font-size: 1.3rem; }
            .mobile-menu-btn { display: flex !important; }
        }
        .mobile-menu-btn { display: none; background: var(--primary); color: white; border: none; padding: 10px; border-radius: 8px; cursor: pointer; align-items: center; justify-content: center; }
    </style>
</head>
<body>
    <!-- í† ìŠ¤íŠ¸ ì»¨í…Œì´ë„ˆ -->
    <div class="toast-container" id="toast-container"></div>
    
    <!-- ë¡œë”© ì˜¤ë²„ë ˆì´ -->
    <div class="loading-overlay" id="loading-overlay">
        <div class="spinner"></div>
        <div style="color: var(--text-muted); font-size: 0.95rem;">ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    </div>
    
    <!-- ========== ì¸ì¦ í™”ë©´ ========== -->
    <div class="auth-overlay" id="auth-overlay">
        <div class="auth-container">
            <div class="auth-logo">
                <img src="https://i.ibb.co/spPvbV5T/Hotel-Care-25.png" alt="HotelCare25">
                <h1>IMS 'UNION</h1>
                <p>í˜¸í…” ë§¤ì¶œ ê´€ë¦¬ ì‹œìŠ¤í…œ (Cloud)</p>
            </div>
            
            <div class="auth-error" id="auth-error"></div>
            
            <div class="auth-tabs">
                <div class="auth-tab active" onclick="switchAuthTab('login')">ë¡œê·¸ì¸</div>
                <div class="auth-tab" onclick="switchAuthTab('register')">íšŒì›ê°€ì…</div>
            </div>
            
            <!-- ë¡œê·¸ì¸ í¼ -->
            <form class="auth-form active" id="login-form" onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label>ì´ë©”ì¼</label>
                    <input type="email" id="login-email" placeholder="ì´ë©”ì¼ ì£¼ì†Œ ì…ë ¥" required>
                </div>
                <div class="form-group">
                    <label>ë¹„ë°€ë²ˆí˜¸</label>
                    <input type="password" id="login-password" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" required>
                </div>
                <button type="submit" class="auth-btn" id="login-btn">ë¡œê·¸ì¸</button>
            </form>
            
            <!-- íšŒì›ê°€ì… í¼ -->
            <form class="auth-form" id="register-form" onsubmit="handleRegister(event)">
                <div class="auth-info">
                    <strong>ğŸ¨ ë©€í‹°í…Œë„ŒíŠ¸ ì•ˆë‚´</strong><br>
                    ì‹ ê·œ ê³ ê°ì‚¬ë¥¼ ë“±ë¡í•˜ê±°ë‚˜, ê¸°ì¡´ ê³ ê°ì‚¬ ì½”ë“œë¡œ ì°¸ì—¬í•˜ì„¸ìš”.
                </div>
                
                <div class="form-group">
                    <label>ê°€ì… ìœ í˜•</label>
                    <select id="register-type" onchange="toggleRegisterType()">
                        <option value="new">ğŸ†• ì‹ ê·œ ê³ ê°ì‚¬ ë“±ë¡ (ê´€ë¦¬ì)</option>
                        <option value="join">ğŸ‘¥ ê¸°ì¡´ ê³ ê°ì‚¬ ì°¸ì—¬ (ì§ì›)</option>
                    </select>
                </div>
                
                <div id="new-tenant-fields">
                    <div class="form-group">
                        <label>í˜¸í…”/ì—…ì²´ëª… *</label>
                        <input type="text" id="register-hotel-name" placeholder="ì˜ˆ: ê·¸ëœë“œ í˜¸í…” ì„œìš¸">
                    </div>
                </div>
                
                <div id="join-tenant-fields" style="display:none;">
                    <div class="form-group">
                        <label>ê³ ê°ì‚¬ ì½”ë“œ *</label>
                        <input type="text" id="register-tenant-code" placeholder="ê´€ë¦¬ìì—ê²Œ ë°›ì€ ì½”ë“œ ì…ë ¥">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>ì´ë¦„ *</label>
                    <input type="text" id="register-name" placeholder="ì´ë¦„" required>
                </div>
                <div class="form-group">
                    <label>ì´ë©”ì¼ *</label>
                    <input type="email" id="register-email" placeholder="ì´ë©”ì¼ ì£¼ì†Œ" required>
                </div>
                <div class="form-group">
                    <label>ë¹„ë°€ë²ˆí˜¸ * (6ì ì´ìƒ)</label>
                    <input type="password" id="register-password" placeholder="ë¹„ë°€ë²ˆí˜¸" required minlength="6">
                </div>
                <div class="form-group">
                    <label>ë¹„ë°€ë²ˆí˜¸ í™•ì¸ *</label>
                    <input type="password" id="register-password-confirm" placeholder="ë¹„ë°€ë²ˆí˜¸ í™•ì¸" required>
                </div>
                
                <button type="submit" class="auth-btn" id="register-btn">íšŒì›ê°€ì…</button>
            </form>
            
            <div class="auth-divider">IMS UNION Â· ì •ë³´ë³´ì•ˆ ë° ê°œì¸ì •ë³´ë³´í˜¸ ì¤€ìˆ˜</div>
        </div>
    </div>
    <!-- ========== ì‚¬ì´ë“œë°” ========== -->
    <nav id="sidebar">
        <div class="brand">
            <img src="https://i.ibb.co/spPvbV5T/Hotel-Care-25.png" alt="HotelCare25">
            <span>HotelCare25</span>
        </div>
        
        <!-- í…Œë„ŒíŠ¸/ì‚¬ìš©ì ì •ë³´ ë°°ì§€ -->
        <div class="tenant-badge">
            <div class="tenant-name"><i data-lucide="building-2" style="width:16px;height:16px;"></i> <span id="sidebar-tenant-name">ë¡œë”© ì¤‘...</span></div>
            <div class="user-info" id="sidebar-user-email">-</div>
            <div class="user-role" id="sidebar-user-role">-</div>
        </div>
        
        <ul class="nav-menu">
            <li class="nav-item" onclick="showSection('hotel-info', this)">
                <i data-lucide="hotel"></i><span>í˜¸í…”ì •ë³´</span>
            </li>
            <li class="nav-item active" onclick="showSection('dashboard', this)">
                <i data-lucide="layout-dashboard"></i><span>ëŒ€ì‹œë³´ë“œ</span>
            </li>
            <li class="nav-item" onclick="showSection('sales', this)">
                <i data-lucide="receipt"></i><span>ë§¤ì¶œ / ì§€ì¶œ</span>
            </li>
            <li class="nav-item" onclick="showSection('monthly-calendar', this)">
                <i data-lucide="calendar-days"></i><span>ì›”ë³„ ë§¤ì¶œê´€ë¦¬</span>
            </li>
            <li class="nav-item" onclick="showSection('ota', this)">
                <i data-lucide="percent"></i><span>OTA / ìˆ˜ìˆ˜ë£Œ ë¶„ì„</span>
            </li>
            <li class="nav-item" onclick="showSection('promotion', this)">
                <i data-lucide="calendar"></i><span>í”„ë¡œëª¨ì…˜</span>
            </li>
            <li class="nav-item" onclick="showSection('kpi', this)">
                <i data-lucide="trending-up"></i><span>KPI ë¶„ì„</span>
            </li>
            <li class="nav-item" onclick="showSection('ai-assistant', this)">
                <i data-lucide="bot"></i><span>AI ì»¨ì„¤í„´íŠ¸</span>
            </li>
            <li class="nav-item" onclick="showSection('report', this)">
                <i data-lucide="file-text"></i><span>ë³´ê³ ì„œ</span>
            </li>
            <li class="nav-item" onclick="showSection('users', this)" id="nav-users" style="display:none;">
                <i data-lucide="users"></i><span>ì‚¬ìš©ì ê´€ë¦¬</span>
            </li>
            <li class="nav-item" onclick="showSection('settings', this)">
                <i data-lucide="settings"></i><span>ì„¤ì •</span>
            </li>
            <li class="nav-item" onclick="showSection('help', this)">
                <i data-lucide="help-circle"></i><span>ë„ì›€ë§</span>
            </li>
        </ul>
        
        <!-- ë™ê¸°í™” ìƒíƒœ -->
        <div class="sync-indicator synced" id="sync-indicator">
            <div class="sync-dot"></div>
            <span id="sync-text">ë™ê¸°í™” ì™„ë£Œ</span>
        </div>
        
        <div class="sidebar-footer">
            <div class="logout-btn" onclick="handleLogout()">
                <i data-lucide="log-out"></i><span>ë¡œê·¸ì•„ì›ƒ</span>
            </div>
        </div>
    </nav>
    
    <!-- ========== ë©”ì¸ ì½˜í…ì¸  ========== -->
    <main id="main-content">
        <header>
            <div style="display: flex; align-items: center; gap: 15px;">
                <button class="mobile-menu-btn" onclick="toggleMobileSidebar()">
                    <i data-lucide="menu"></i>
                </button>
                <button class="toggle-fullscreen-btn" onclick="toggleSidebar()">
                    <i data-lucide="sidebar"></i> ì „ì²´í™”ë©´
                </button>
                <h2 id="current-section-title">ëŒ€ì‹œë³´ë“œ</h2>
            </div>
            <div class="user-profile">
                <div class="alert-badge" onclick="showNotification()">
                    <i data-lucide="bell"></i>
                    <div class="badge-dot" id="kpi-alert-dot" style="display:none;"></div>
                </div>
                <div id="today-date" style="font-weight: 600; font-size: 0.9rem; margin-left: 10px;"></div>
            </div>
        </header>
        
        <div class="container">
        
        <!-- ========== í˜¸í…”ì •ë³´ Section ========== -->
        <div id="hotel-info" class="content-section">
            <div class="grid-2">
                <div class="card">
                    <h3 class="section-title"><i data-lucide="building"></i> ê¸°ë³¸ ì‹œì„¤ ì •ë³´</h3>
                    <div class="form-group">
                        <label>í˜¸í…”ëª…</label>
                        <input type="text" id="hotel-name" placeholder="í˜¸í…” ì´ë¦„">
                    </div>
                    <div class="grid-2" style="grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div class="form-group">
                            <label>ì´ ê°ì‹¤ ìˆ˜</label>
                            <input type="number" id="total-rooms" placeholder="ì´ ê°ì‹¤ ìˆ˜">
                        </div>
                        <div class="form-group">
                            <label>ê±´ë¬¼ ì¸µìˆ˜</label>
                            <input type="number" id="floors" placeholder="ì¸µ ìˆ˜">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>ì›”ê°„ ëª©í‘œ ë§¤ì¶œ (KPI ê¸°ì¤€)</label>
                        <input type="number" id="min-sales-target" placeholder="â‚©">
                    </div>
                    <div class="grid-3" style="margin-top: 15px;">
                        <div class="form-group">
                            <label>í‰ê·  ë§¤ì¶œ (ì›)</label>
                            <input type="number" id="avg-sales">
                        </div>
                        <div class="form-group">
                            <label>í‰ê·  ê°ì‹¤íŒë§¤ìˆ˜</label>
                            <input type="number" id="avg-rooms-sold">
                        </div>
                        <div class="form-group">
                            <label>í‰ê·  ì ìœ ìœ¨ (%)</label>
                            <input type="number" id="avg-occupancy">
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="saveHotelInfo()" style="width: 100%; margin-top: 15px;">
                        <i data-lucide="save"></i> ì„¤ì • ì €ì¥
                    </button>
                </div>
                
                <div class="card">
                    <h3 class="section-title"><i data-lucide="bed"></i> ê°ì‹¤ íƒ€ì… ë° ë‹¨ê°€ ì„¤ì •</h3>
                    <div id="room-types-list"></div>
                    <button class="btn btn-secondary" style="width: 100%; margin-top: 10px;" onclick="addRoomTypeRow()">
                        <i data-lucide="plus"></i> íƒ€ì… ì¶”ê°€
                    </button>
                    
                    <div style="margin-top: 25px; padding-top: 20px; border-top: 1px solid var(--gray-200);">
                        <h4 style="margin-bottom: 15px; font-weight: 600;">ë¶€ëŒ€ì‹œì„¤ë³„ ë‹¨ê°€ ì„¤ì •</h4>
                        <div id="facilities-list"></div>
                        <button class="btn btn-secondary" style="width: 100%; margin-top: 10px;" onclick="addFacilityRow()">
                            <i data-lucide="plus"></i> ë¶€ëŒ€ì‹œì„¤ ì¶”ê°€
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- ê´€ë¦¬ì ì „ìš©: í…Œë„ŒíŠ¸ ì •ë³´ -->
            <div class="card" id="tenant-info-card" style="display:none;">
                <h3 class="section-title"><i data-lucide="key"></i> ê³ ê°ì‚¬ ì •ë³´ (ê´€ë¦¬ì ì „ìš©)</h3>
                <div class="auth-info">
                    <p><strong>í…Œë„ŒíŠ¸ ID:</strong> <span id="display-tenant-id">-</span></p>
                    <p style="margin-top:8px;"><strong>ì´ˆëŒ€ ì½”ë“œ:</strong> <span id="display-tenant-code" style="font-family:monospace; font-size:1.1rem;">-</span>
                    <button class="btn btn-secondary" style="padding: 5px 12px; font-size: 0.8rem; margin-left: 10px;" onclick="copyTenantCode()">ë³µì‚¬</button></p>
                </div>
                <p style="font-size: 0.85rem; color: var(--text-muted); margin-top: 15px;">
                    ìƒˆ ì§ì›ì´ ê°€ì…í•  ë•Œ ìœ„ ì´ˆëŒ€ ì½”ë“œë¥¼ ê³µìœ í•˜ì„¸ìš”. í•´ë‹¹ ì½”ë“œë¡œ ê°€ì…í•œ ì‚¬ìš©ìëŠ” ìë™ìœ¼ë¡œ ì´ ê³ ê°ì‚¬ì— ì—°ê²°ë©ë‹ˆë‹¤.
                </p>
            </div>
        </div>
        
        <!-- ========== ëŒ€ì‹œë³´ë“œ Section ========== -->
        <div id="dashboard" class="content-section active">
            <div class="grid-4">
                <div class="card stat-card">
                    <span class="stat-label">ìˆœìˆ˜ë§¤ì¶œ <span class="term-explanation" title="ì „ì²´ ë§¤ì¶œ - ìˆ˜ìˆ˜ë£Œ - ì§€ì¶œ">?</span></span>
                    <span class="stat-value" id="dashboard-net-sales">â‚©0</span>
                    <span class="stat-change" id="dashboard-net-sales-change">ëª©í‘œ ì¶”ì  ì¤‘</span>
                </div>
                <div class="card stat-card">
                    <span class="stat-label">ì „ì²´ë§¤ì¶œ <span class="term-explanation" title="ëª¨ë“  ì±„ë„ì˜ ë§¤ì¶œ í•©ê³„">?</span></span>
                    <span class="stat-value" id="dashboard-total-sales">â‚©0</span>
                    <span class="stat-change" id="dashboard-total-sales-change"></span>
                </div>
                <div class="card stat-card">
                    <span class="stat-label">OTA / ìˆ˜ìˆ˜ë£Œ <span class="term-explanation" title="ì˜ˆì•½í”Œë«í¼ ìˆ˜ìˆ˜ë£Œ í•©ê³„">?</span></span>
                    <span class="stat-value" id="dashboard-ota-fee">â‚©0</span>
                    <span class="stat-change" id="dashboard-ota-fee-change"></span>
                </div>
                <div class="card stat-card">
                    <span class="stat-label">ì ìœ ìœ¨ (OCC) <span class="term-explanation" title="íŒë§¤ ê°ì‹¤ ìˆ˜ / (ì´ ê°ì‹¤ ìˆ˜ Ã— ì¼ìˆ˜) Ã— 100">?</span></span>
                    <span class="stat-value" id="dashboard-occupancy">0%</span>
                    <span class="stat-change" id="dashboard-occupancy-change">-</span>
                </div>
            </div>
            
            <div class="grid-2">
                <div class="card">
                    <h3 class="section-title"><i data-lucide="bar-chart-3"></i> ë§¤ì¶œ ì¶”ì´</h3>
                    <div style="margin-bottom: 15px;">
                        <select id="chart-period" onchange="updateDashboardChart()" style="padding: 8px 12px; border-radius: 8px;">
                            <option value="daily">ì¼ë³„</option>
                            <option value="weekly">ì£¼ë³„</option>
                            <option value="monthly" selected>ì›”ë³„</option>
                        </select>
                    </div>
                    <div style="height: 280px;">
                        <canvas id="sales-trend-chart"></canvas>
                    </div>
                </div>
                <div class="card">
                    <h3 class="section-title"><i data-lucide="pie-chart"></i> ì±„ë„ë³„ ë§¤ì¶œ ë¹„ì¤‘</h3>
                    <div style="height: 280px;">
                        <canvas id="channel-pie-chart"></canvas>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <h3 class="section-title"><i data-lucide="list"></i> ìµœê·¼ ê±°ë˜ ë‚´ì—­</h3>
                <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                    <table>
                        <thead>
                            <tr><th>ë‚ ì§œ</th><th>êµ¬ë¶„</th><th>ì±„ë„</th><th>í•­ëª©</th><th>ê¸ˆì•¡</th><th>ìˆ˜ìˆ˜ë£Œ</th><th>ë©”ëª¨</th></tr>
                        </thead>
                        <tbody id="recent-transactions"></tbody>
                    </table>
                </div>
            </div>
        </div>
        <!-- ========== ë§¤ì¶œ/ì§€ì¶œ Section ========== -->
        <div id="sales" class="content-section">
            <div class="grid-2">
                <div class="card">
                    <h3 class="section-title"><i data-lucide="plus-circle"></i> ë§¤ì¶œ ì…ë ¥</h3>
                    <div class="form-group">
                        <label>ë‚ ì§œ</label>
                        <input type="date" id="sales-date">
                    </div>
                    <div class="form-group">
                        <label>ì±„ë„</label>
                        <select id="sales-channel" onchange="onSalesChannelChange()">
                            <option value="room">ê°ì‹¤ ë§¤ì¶œ</option>
                            <option value="ota">OTA ì˜ˆì•½</option>
                            <option value="direct">ì§ì ‘ ì˜ˆì•½</option>
                            <option value="group">ë‹¨ì²´</option>
                            <option value="facility">ë¶€ëŒ€ì‹œì„¤</option>
                            <option value="other">ê¸°íƒ€</option>
                        </select>
                    </div>
                    <div class="form-group" id="ota-category-group" style="display:none;">
                        <label>OTA ì„ íƒ</label>
                        <select id="ota-category"></select>
                    </div>
                    <div class="form-group" id="room-type-group">
                        <label>ê°ì‹¤ íƒ€ì…</label>
                        <select id="room-type-select" onchange="onRoomTypeSelect()"></select>
                    </div>
                    <div class="form-group" id="facility-group" style="display:none;">
                        <label>ë¶€ëŒ€ì‹œì„¤</label>
                        <select id="facility-select" onchange="onFacilitySelect()"></select>
                    </div>
                    <div class="grid-2" style="grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div class="form-group">
                            <label>ìˆ˜ëŸ‰</label>
                            <input type="number" id="room-count" value="1" min="1" onchange="calcSalesAmount()">
                        </div>
                        <div class="form-group">
                            <label>ë‹¨ê°€ (â‚©)</label>
                            <input type="number" id="room-unit-price" placeholder="0" onchange="calcSalesAmount()">
                        </div>
                    </div>
                    <div class="grid-2" style="grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div class="form-group">
                            <label>ì´ ê¸ˆì•¡ (â‚©)</label>
                            <input type="number" id="sales-amount" placeholder="ìë™ ê³„ì‚°">
                        </div>
                        <div class="form-group">
                            <label>ìˆ˜ìˆ˜ë£Œ (â‚©)</label>
                            <input type="number" id="sales-fee" placeholder="0" value="0">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>ë©”ëª¨</label>
                        <input type="text" id="sales-note" placeholder="ë©”ëª¨ (ì„ íƒ)">
                    </div>
                    <button class="btn btn-primary" onclick="addRevenueEntry()" style="width: 100%;">
                        <i data-lucide="plus"></i> ë§¤ì¶œ ì¶”ê°€
                    </button>
                </div>
                
                <div class="card">
                    <h3 class="section-title"><i data-lucide="minus-circle"></i> ì§€ì¶œ ì…ë ¥</h3>
                    <div class="form-group">
                        <label>ë‚ ì§œ</label>
                        <input type="date" id="expense-date">
                    </div>
                    <div class="form-group">
                        <label>ì§€ì¶œ í•­ëª©</label>
                        <select id="expense-category">
                            <option value="labor">ì¸ê±´ë¹„</option>
                            <option value="utility">ê³µê³¼ê¸ˆ/ìœ í‹¸ë¦¬í‹°</option>
                            <option value="maintenance">ìœ ì§€ë³´ìˆ˜</option>
                            <option value="marketing">ë§ˆì¼€íŒ…/ê´‘ê³ </option>
                            <option value="supplies">ì†Œëª¨í’ˆ</option>
                            <option value="other">ê¸°íƒ€</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ê¸ˆì•¡ (â‚©)</label>
                        <input type="number" id="expense-amount" placeholder="ê¸ˆì•¡">
                    </div>
                    <div class="form-group">
                        <label>ë©”ëª¨</label>
                        <input type="text" id="expense-note" placeholder="ë©”ëª¨ (ì„ íƒ)">
                    </div>
                    <button class="btn btn-danger" onclick="addExpenseEntry()" style="width: 100%;">
                        <i data-lucide="minus"></i> ì§€ì¶œ ì¶”ê°€
                    </button>
                </div>
            </div>
            
            <div class="card">
                <h3 class="section-title"><i data-lucide="list"></i> ë§¤ì¶œ/ì§€ì¶œ ë‚´ì—­</h3>
                <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
                    <input type="date" id="filter-start" style="padding: 8px;">
                    <span style="align-self: center;">~</span>
                    <input type="date" id="filter-end" style="padding: 8px;">
                    <button class="btn btn-secondary" onclick="filterSalesList()">í•„í„°</button>
                    <button class="btn btn-secondary" onclick="clearSalesFilter()">ì´ˆê¸°í™”</button>
                </div>
                <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                    <table>
                        <thead>
                            <tr><th>ë‚ ì§œ</th><th>êµ¬ë¶„</th><th>ì±„ë„</th><th>í•­ëª©</th><th>ìˆ˜ëŸ‰</th><th>ê¸ˆì•¡</th><th>ìˆ˜ìˆ˜ë£Œ</th><th>ìˆœë§¤ì¶œ</th><th>ë©”ëª¨</th><th>ê´€ë¦¬</th></tr>
                        </thead>
                        <tbody id="sales-list-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- ========== ì›”ë³„ ë§¤ì¶œê´€ë¦¬ Section ========== -->
        <div id="monthly-calendar" class="content-section">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <button class="btn btn-secondary" onclick="changeCalendarMonth(-1)">â—€ ì´ì „</button>
                    <h3 id="calendar-title" style="margin: 0;"></h3>
                    <button class="btn btn-secondary" onclick="changeCalendarMonth(1)">ë‹¤ìŒ â–¶</button>
                </div>
                <div id="monthly-calendar-grid" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px;"></div>
            </div>
            
            <div class="grid-2">
                <div class="card">
                    <h3 class="section-title"><i data-lucide="calendar-check"></i> ì›”ê°„ ìš”ì•½</h3>
                    <div id="monthly-summary"></div>
                </div>
                <div class="card">
                    <h3 class="section-title"><i data-lucide="trending-up"></i> ê¸°ê°„ë³„ ë¶„ì„</h3>
                    <div id="period-analysis"></div>
                </div>
            </div>
        </div>
        
        <!-- ========== OTA/ìˆ˜ìˆ˜ë£Œ ë¶„ì„ Section ========== -->
        <div id="ota" class="content-section">
            <div class="grid-2">
                <div class="card">
                    <h3 class="section-title"><i data-lucide="globe"></i> OTA ë“±ë¡</h3>
                    <div class="form-group">
                        <label>OTAëª…</label>
                        <input type="text" id="ota-name" placeholder="ì˜ˆ: Booking.com">
                    </div>
                    <div class="form-group">
                        <label>ê¸°ë³¸ ìˆ˜ìˆ˜ë£Œìœ¨ (%)</label>
                        <input type="number" id="ota-fee-rate" placeholder="ì˜ˆ: 15" step="0.1">
                    </div>
                    <button class="btn btn-primary" onclick="addOTA()" style="width: 100%;">
                        <i data-lucide="plus"></i> OTA ë“±ë¡
                    </button>
                </div>
                <div class="card">
                    <h3 class="section-title"><i data-lucide="bar-chart-2"></i> CRR ë¶„ì„</h3>
                    <div style="height: 200px;">
                        <canvas id="crr-chart"></canvas>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <h3 class="section-title"><i data-lucide="list"></i> ë“±ë¡ëœ OTA ëª©ë¡</h3>
                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr><th>OTAëª…</th><th>ìˆ˜ìˆ˜ë£Œìœ¨</th><th>ì´ ë§¤ì¶œ</th><th>ì´ ìˆ˜ìˆ˜ë£Œ</th><th>ì‹¤ì œ CRR</th><th>ê´€ë¦¬</th></tr>
                        </thead>
                        <tbody id="ota-list-body"></tbody>
                    </table>
                </div>
            </div>
            
            <div class="card">
                <h3 class="section-title"><i data-lucide="lightbulb"></i> AI ìˆ˜ìˆ˜ë£Œ ë¶„ì„ ê°€ì´ë“œ</h3>
                <div id="ai-fee-guide" style="line-height: 1.8;">ë°ì´í„°ê°€ ì¶©ë¶„í•˜ë©´ AI ë¶„ì„ ê²°ê³¼ê°€ í‘œì‹œë©ë‹ˆë‹¤.</div>
            </div>
        </div>
        
        <!-- ========== í”„ë¡œëª¨ì…˜ Section ========== -->
        <div id="promotion" class="content-section">
            <div class="grid-2">
                <div class="card">
                    <h3 class="section-title"><i data-lucide="tag"></i> í”„ë¡œëª¨ì…˜ ë“±ë¡</h3>
                    <div class="form-group">
                        <label>í”„ë¡œëª¨ì…˜ëª…</label>
                        <input type="text" id="promo-name" placeholder="ì˜ˆ: ì—¬ë¦„ íŠ¹ê°€">
                    </div>
                    <div class="grid-2" style="grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div class="form-group">
                            <label>ì‹œì‘ì¼</label>
                            <input type="date" id="promo-start">
                        </div>
                        <div class="form-group">
                            <label>ì¢…ë£Œì¼</label>
                            <input type="date" id="promo-end">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>í• ì¸ìœ¨ (%)</label>
                        <input type="number" id="promo-discount" placeholder="ì˜ˆ: 20">
                    </div>
                    <div class="form-group">
                        <label>ì ìš© ì±„ë„</label>
                        <select id="promo-channel">
                            <option value="all">ì „ì²´</option>
                            <option value="ota">OTA</option>
                            <option value="direct">ì§ì ‘ì˜ˆì•½</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ë©”ëª¨</label>
                        <textarea id="promo-memo" rows="2" placeholder="í”„ë¡œëª¨ì…˜ ìƒì„¸"></textarea>
                    </div>
                    <button class="btn btn-primary" onclick="addPromotion()" style="width: 100%;">
                        <i data-lucide="plus"></i> í”„ë¡œëª¨ì…˜ ë“±ë¡
                    </button>
                </div>
                <div class="card">
                    <h3 class="section-title"><i data-lucide="calendar"></i> í”„ë¡œëª¨ì…˜ ìº˜ë¦°ë”</h3>
                    <div id="promo-calendar"></div>
                </div>
            </div>
            <div class="card">
                <h3 class="section-title"><i data-lucide="list"></i> í”„ë¡œëª¨ì…˜ ëª©ë¡</h3>
                <div class="table-responsive">
                    <table>
                        <thead><tr><th>ì´ë¦„</th><th>ê¸°ê°„</th><th>í• ì¸ìœ¨</th><th>ì±„ë„</th><th>ìƒíƒœ</th><th>ê´€ë¦¬</th></tr></thead>
                        <tbody id="promo-list-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- ========== KPI ë¶„ì„ Section ========== -->
        <div id="kpi" class="content-section">
            <div class="card" style="background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white;">
                <h3 class="section-title" style="color: white;"><i data-lucide="target"></i> KPI ë‹¬ì„± í˜„í™©</h3>
                <div id="kpi-summary" style="line-height: 1.8;"></div>
            </div>
            
            <div class="grid-4">
                <div class="card stat-card">
                    <span class="stat-label">RevPAR <span class="term-explanation" title="Revenue Per Available Room\nì´ ê°ì‹¤ ë§¤ì¶œ Ã· (ì´ ê°ì‹¤ ìˆ˜ Ã— ì¼ìˆ˜)">?</span></span>
                    <span class="stat-value" id="kpi-revpar">â‚©0</span>
                    <span class="stat-change" id="kpi-revpar-status">-</span>
                </div>
                <div class="card stat-card">
                    <span class="stat-label">ADR <span class="term-explanation" title="Average Daily Rate\nì´ ê°ì‹¤ ë§¤ì¶œ Ã· íŒë§¤ ê°ì‹¤ ìˆ˜">?</span></span>
                    <span class="stat-value" id="kpi-adr">â‚©0</span>
                    <span class="stat-change" id="kpi-adr-status">-</span>
                </div>
                <div class="card stat-card">
                    <span class="stat-label">OCC <span class="term-explanation" title="Occupancy Rate\níŒë§¤ ê°ì‹¤ ìˆ˜ Ã· ì´ ê°ì‹¤ ìˆ˜ Ã— 100">?</span></span>
                    <span class="stat-value" id="kpi-occ">0%</span>
                    <span class="stat-change" id="kpi-occ-status">-</span>
                </div>
                <div class="card stat-card">
                    <span class="stat-label">CRR <span class="term-explanation" title="Commission Rate\nìˆ˜ìˆ˜ë£Œ Ã· ë§¤ì¶œ Ã— 100 (ë‚®ì„ìˆ˜ë¡ ì¢‹ìŒ)">?</span></span>
                    <span class="stat-value" id="kpi-crr">0%</span>
                    <span class="stat-change" id="kpi-crr-status">-</span>
                </div>
            </div>
            
            <div class="grid-2">
                <div class="card">
                    <h3 class="section-title"><i data-lucide="bed"></i> ê°ì‹¤ íƒ€ì…ë³„ ì„±ê³¼</h3>
                    <div class="table-responsive">
                        <table>
                            <thead><tr><th>ê°ì‹¤ íƒ€ì…</th><th>íŒë§¤ ìˆ˜</th><th>ë§¤ì¶œ</th><th>ë¹„ì¤‘</th></tr></thead>
                            <tbody id="room-performance-body"></tbody>
                        </table>
                    </div>
                </div>
                <div class="card">
                    <h3 class="section-title"><i data-lucide="pie-chart"></i> ì±„ë„ë³„ ì„±ê³¼</h3>
                    <div class="table-responsive">
                        <table>
                            <thead><tr><th>ì±„ë„</th><th>ë§¤ì¶œ</th><th>ìˆ˜ìˆ˜ë£Œ</th><th>ìˆœì´ìµ</th><th>ë¹„ì¤‘</th></tr></thead>
                            <tbody id="channel-performance-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <!-- ========== AI ì»¨ì„¤í„´íŠ¸ Section ========== -->
        <div id="ai-assistant" class="content-section">
            <div class="card" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white;">
                <h3 class="section-title" style="color: white;"><i data-lucide="bot"></i> AI ì»¨ì„¤í„´íŠ¸</h3>
                <p>ë§¤ì¶œ ë°ì´í„°ë¥¼ ë¶„ì„í•˜ì—¬ ì¸ì‚¬ì´íŠ¸ì™€ ê°œì„  ë°©ì•ˆì„ ì œì‹œí•©ë‹ˆë‹¤.</p>
            </div>
            
            <div class="card">
                <h3 class="section-title"><i data-lucide="message-square"></i> AIì—ê²Œ ì§ˆë¬¸í•˜ê¸°</h3>
                <div class="form-group">
                    <textarea id="ai-question" rows="3" placeholder="ì˜ˆ: ì´ë²ˆ ë‹¬ ë§¤ì¶œ í˜„í™©ì€? / ìˆ˜ìˆ˜ë£Œë¥¼ ì¤„ì¼ ë°©ë²•ì€? / ì ìœ ìœ¨ í–¥ìƒ ì „ëµì€?"></textarea>
                </div>
                <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px;">
                    <button class="btn btn-secondary" onclick="askAI('ì´ë²ˆ ë‹¬ ë§¤ì¶œ í˜„í™© ë¶„ì„í•´ì¤˜')">ğŸ“Š ë§¤ì¶œ í˜„í™©</button>
                    <button class="btn btn-secondary" onclick="askAI('KPI ë‹¬ì„±ë¥  ë¶„ì„í•´ì¤˜')">ğŸ¯ KPI ë¶„ì„</button>
                    <button class="btn btn-secondary" onclick="askAI('ìˆ˜ìˆ˜ë£Œ íš¨ìœ¨ì„± ë¶„ì„í•´ì¤˜')">ğŸ’¸ ìˆ˜ìˆ˜ë£Œ ë¶„ì„</button>
                    <button class="btn btn-secondary" onclick="askAI('ì±„ë„ë³„ ìˆ˜ìµì„± ë¹„êµí•´ì¤˜')">ğŸ“ˆ ì±„ë„ ë¶„ì„</button>
                    <button class="btn btn-secondary" onclick="askAI('ë§¤ì¶œ í–¥ìƒ ì „ëµ ì œì•ˆí•´ì¤˜')">ğŸš€ ê°œì„  ì „ëµ</button>
                </div>
                <button class="btn btn-primary" onclick="submitAIQuestion()" style="width: 100%;">
                    <i data-lucide="send"></i> ì§ˆë¬¸í•˜ê¸°
                </button>
            </div>
            
            <div class="card">
                <h3 class="section-title"><i data-lucide="lightbulb"></i> AI ì‘ë‹µ</h3>
                <div id="ai-response" style="min-height: 150px; line-height: 1.8; white-space: pre-wrap;">
                    ì§ˆë¬¸ì„ ì…ë ¥í•˜ë©´ AIê°€ ë°ì´í„°ë¥¼ ë¶„ì„í•˜ì—¬ ë‹µë³€í•©ë‹ˆë‹¤.
                </div>
            </div>
        </div>
        
        <!-- ========== ë³´ê³ ì„œ Section ========== -->
        <div id="report" class="content-section">
            <div class="card">
                <h3 class="section-title"><i data-lucide="file-text"></i> ë³´ê³ ì„œ ìƒì„±</h3>
                <div class="grid-3" style="margin-bottom: 20px; align-items: flex-end;">
                    <div class="form-group" style="margin-bottom:0;">
                        <label>ë³´ê³ ì„œ ìœ í˜•</label>
                        <select id="report-type">
                            <option value="monthly">ì›”ê°„ ë³´ê³ ì„œ</option>
                            <option value="quarterly">ë¶„ê¸° ë³´ê³ ì„œ</option>
                            <option value="yearly">ì—°ê°„ ë³´ê³ ì„œ</option>
                        </select>
                    </div>
                    <div class="form-group" style="margin-bottom:0;">
                        <label>ê¸°ì¤€ ë‚ ì§œ</label>
                        <input type="date" id="report-date">
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-primary" onclick="generateReport()">
                            <i data-lucide="file-plus"></i> ìƒì„±
                        </button>
                        <button class="btn btn-secondary" onclick="printReport()">
                            <i data-lucide="printer"></i> ì¸ì‡„
                        </button>
                    </div>
                </div>
            </div>
            <div class="card" id="report-preview">
                <div style="text-align: center; padding: 50px; color: var(--text-muted);">
                    ë³´ê³ ì„œë¥¼ ìƒì„±í•˜ë©´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.
                </div>
            </div>
        </div>
        
        <!-- ========== ì‚¬ìš©ì ê´€ë¦¬ Section (ê´€ë¦¬ì ì „ìš©) ========== -->
        <div id="users" class="content-section">
            <div class="card">
                <h3 class="section-title"><i data-lucide="users"></i> ì‚¬ìš©ì ê´€ë¦¬</h3>
                <div class="auth-info" style="margin-bottom: 20px;">
                    <strong>í˜„ì¬ ê³ ê°ì‚¬:</strong> <span id="users-tenant-name">-</span><br>
                    <strong>ì´ˆëŒ€ ì½”ë“œ:</strong> <span id="users-tenant-code" style="font-family: monospace;">-</span>
                    <button class="btn btn-secondary" style="padding: 3px 10px; font-size: 0.75rem; margin-left: 8px;" onclick="copyTenantCode()">ë³µì‚¬</button>
                </div>
                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr><th>ì´ë¦„</th><th>ì´ë©”ì¼</th><th>ì—­í• </th><th>ê°€ì…ì¼</th><th>ìƒíƒœ</th><th>ê´€ë¦¬</th></tr>
                        </thead>
                        <tbody id="users-list-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- ========== ì„¤ì • Section ========== -->
        <div id="settings" class="content-section">
            <div class="grid-2">
                <div class="card">
                    <h3 class="section-title"><i data-lucide="database"></i> ë°ì´í„° ê´€ë¦¬</h3>
                    <div style="display: flex; flex-direction: column; gap: 12px;">
                        <button class="btn btn-secondary" onclick="exportData()">
                            <i data-lucide="download"></i> ë°ì´í„° ë‚´ë³´ë‚´ê¸° (JSON)
                        </button>
                        <button class="btn btn-secondary" onclick="document.getElementById('import-file').click()">
                            <i data-lucide="upload"></i> ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                        </button>
                        <input type="file" id="import-file" accept=".json" style="display:none;" onchange="importData(event)">
                        <hr style="border: none; border-top: 1px solid var(--gray-200);">
                        <button class="btn btn-danger" onclick="confirmClearData()">
                            <i data-lucide="trash-2"></i> ëª¨ë“  ë°ì´í„° ì´ˆê¸°í™”
                        </button>
                    </div>
                </div>
                
                <div class="card">
                    <h3 class="section-title"><i data-lucide="info"></i> ì‹œìŠ¤í…œ ì •ë³´</h3>
                    <div style="font-size: 0.9rem; line-height: 2;">
                        <p><strong>ë²„ì „:</strong> HotelCare25 v2.0 (Firebase Cloud)</p>
                        <p><strong>ë°ì´í„° ì €ì¥:</strong> Google Firebase Firestore</p>
                        <p><strong>ì¸ì¦:</strong> Firebase Authentication</p>
                        <p><strong>ë³´ì•ˆ:</strong> í…Œë„ŒíŠ¸ë³„ ë°ì´í„° ì™„ì „ ê²©ë¦¬, TLS ì•”í˜¸í™”</p>
                        <p><strong>ê°œì¸ì •ë³´:</strong> ìµœì†Œ ìˆ˜ì§‘ ì›ì¹™, ê³ ê°ì‚¬ë³„ ë…ë¦½ ê´€ë¦¬</p>
                    </div>
                </div>
            </div>
            
            <div class="card" id="admin-settings-card" style="display:none;">
                <h3 class="section-title"><i data-lucide="shield"></i> ê´€ë¦¬ì ì„¤ì •</h3>
                <div class="auth-info">
                    <p><strong>í…Œë„ŒíŠ¸ ID:</strong> <span id="settings-tenant-id">-</span></p>
                    <p style="margin-top:8px;"><strong>ì´ˆëŒ€ ì½”ë“œ:</strong> <code id="settings-tenant-code" style="background: var(--gray-100); padding: 4px 10px; border-radius: 4px;">-</code>
                    <button class="btn btn-secondary" style="padding: 4px 10px; font-size: 0.8rem; margin-left: 8px;" onclick="copyTenantCode()">ë³µì‚¬</button></p>
                </div>
                <p style="font-size: 0.85rem; color: var(--text-muted); margin-top: 15px;">
                    ìƒˆ ì§ì›ì´ ê°€ì…í•  ë•Œ ìœ„ ì´ˆëŒ€ ì½”ë“œë¥¼ ê³µìœ í•˜ì„¸ìš”.<br>
                    í•´ë‹¹ ì½”ë“œë¡œ ê°€ì…í•œ ì‚¬ìš©ìëŠ” ìë™ìœ¼ë¡œ ì´ ê³ ê°ì‚¬ì— ì—°ê²°ë©ë‹ˆë‹¤.
                </p>
            </div>
        </div>
        
        <!-- ========== ë„ì›€ë§ Section ========== -->
        <div id="help" class="content-section">
            <div class="card">
                <h3 class="section-title"><i data-lucide="book-open"></i> ì‚¬ìš© ê°€ì´ë“œ</h3>
                <div style="line-height: 1.9; font-size: 0.95rem;">
                    <h4 style="color: var(--primary); margin: 20px 0 12px;">ğŸ” ê³„ì • ë° ë³´ì•ˆ</h4>
                    <ul style="padding-left: 22px;">
                        <li><strong>ë©€í‹°í…Œë„ŒíŠ¸:</strong> ê° ê³ ê°ì‚¬(í˜¸í…”)ì˜ ë°ì´í„°ëŠ” ì™„ì „íˆ ê²©ë¦¬ë©ë‹ˆë‹¤.</li>
                        <li><strong>ì—­í•  êµ¬ë¶„:</strong> ê´€ë¦¬ì(admin)ëŠ” ì‚¬ìš©ì ê´€ë¦¬, ì§ì›(staff)ì€ ë°ì´í„° ì…ë ¥/ì¡°íšŒ</li>
                        <li><strong>ì´ˆëŒ€ ì½”ë“œ:</strong> ê´€ë¦¬ìê°€ ê³µìœ í•œ ì½”ë“œë¡œ ìƒˆ ì§ì›ì´ ê°€ì…í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
                        <li><strong>ì‹¤ì‹œê°„ ë™ê¸°í™”:</strong> ì—¬ëŸ¬ ê¸°ê¸°ì—ì„œ ë™ì‹œ ì ‘ì†í•´ë„ ë°ì´í„°ê°€ ì‹¤ì‹œê°„ ë™ê¸°í™”ë©ë‹ˆë‹¤.</li>
                    </ul>
                    
                    <h4 style="color: var(--primary); margin: 25px 0 12px;">ğŸ“Š ì£¼ìš” ì§€í‘œ (KPI)</h4>
                    <ul style="padding-left: 22px;">
                        <li><strong>RevPAR:</strong> Revenue Per Available Room = ì´ ê°ì‹¤ ë§¤ì¶œ Ã· (ì´ ê°ì‹¤ ìˆ˜ Ã— ì¼ìˆ˜)</li>
                        <li><strong>ADR:</strong> Average Daily Rate = ì´ ê°ì‹¤ ë§¤ì¶œ Ã· íŒë§¤ ê°ì‹¤ ìˆ˜</li>
                        <li><strong>OCC:</strong> Occupancy Rate = íŒë§¤ ê°ì‹¤ ìˆ˜ Ã· ì´ ê°ì‹¤ ìˆ˜ Ã— 100</li>
                        <li><strong>CRR:</strong> Commission Rate = ìˆ˜ìˆ˜ë£Œ Ã· ë§¤ì¶œ Ã— 100 (ë‚®ì„ìˆ˜ë¡ ì¢‹ìŒ)</li>
                    </ul>
                    
                    <h4 style="color: var(--primary); margin: 25px 0 12px;">ğŸ’¡ íŒ</h4>
                    <ul style="padding-left: 22px;">
                        <li>ë°ì´í„°ëŠ” ì…ë ¥ ì¦‰ì‹œ í´ë¼ìš°ë“œì— ìë™ ì €ì¥ë©ë‹ˆë‹¤.</li>
                        <li>ì •ê¸°ì ìœ¼ë¡œ "ë°ì´í„° ë‚´ë³´ë‚´ê¸°"ë¡œ ë°±ì—…í•˜ëŠ” ê²ƒì„ ê¶Œì¥í•©ë‹ˆë‹¤.</li>
                        <li>AI ì»¨ì„¤í„´íŠ¸ì—ê²Œ ìì—°ì–´ë¡œ ì§ˆë¬¸í•˜ì—¬ ì¸ì‚¬ì´íŠ¸ë¥¼ ì–»ìœ¼ì„¸ìš”.</li>
                    </ul>
                </div>
            </div>
        </div>
        
        </div> <!-- container end -->
    </main>
    
    <!-- ========== ëª¨ë‹¬ ========== -->
    <div class="custom-modal" id="custom-modal">
        <div class="custom-modal-content">
            <div class="custom-modal-header">
                <h2 id="modal-title">ì•Œë¦¼</h2>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="custom-modal-body" id="modal-body"></div>
            <div class="custom-modal-footer" id="modal-footer"></div>
        </div>
    </div>
    <script>
        // ============================================================
        // Firebase ì„¤ì • (ì‚¬ìš©ìê°€ ì§ì ‘ ì…ë ¥í•´ì•¼ í•¨)
        // ============================================================
        const firebaseConfig = {
            // TODO: Firebase Consoleì—ì„œ ë°œê¸‰ë°›ì€ ì„¤ì •ì„ ì—¬ê¸°ì— ì…ë ¥í•˜ì„¸ìš”
            apiKey: "AIzaSyCl2JLnvjfAbng7XzW3mrbdZZ1Mzev-EyU",
            authDomain: "ims-union-hotelcare25-spm.firebaseapp.com",
            projectId: "ims-union-hotelcare25-spm",
            storageBucket: "ims-union-hotelcare25-spm.firebasestorage.app",
            messagingSenderId: "276965965686",
            appId: "1:276965965686:web:765729bf8d274c7dcf0457"
        };
        
        // Firebase ì´ˆê¸°í™”
        let app, auth, db;
        try {
            app = firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            db = firebase.firestore();
            
            // ì˜¤í”„ë¼ì¸ ì§€ì› í™œì„±í™”
            db.enablePersistence().catch(err => {
                if (err.code === 'failed-precondition') {
                    console.log('Multiple tabs open, persistence enabled in first tab only');
                } else if (err.code === 'unimplemented') {
                    console.log('Browser does not support persistence');
                }
            });
        } catch (e) {
            console.error('Firebase initialization error:', e);
        }
        
        // ============================================================
        // ì „ì—­ ë³€ìˆ˜
        // ============================================================
        let currentUser = null;
        let currentTenant = null;
        let currentUserRole = 'staff';
        let unsubscribeListeners = [];
        
        let appData = {
            hotelInfo: {
                name: '', totalRooms: 100, floors: 10,
                roomTypes: [], facilities: [],
                avgSales: 0, avgRoomsSold: 0, avgOccupancy: 0,
                minSalesTarget: 0
            },
            sales: [],
            expenses: [],
            otas: [],
            promotions: []
        };
        
        let charts = {};
        let currentCalendarDate = new Date();
        let salesFilter = { start: null, end: null };
        
        // ============================================================
        // ì¸ì¦ ê´€ë ¨ í•¨ìˆ˜
        // ============================================================
        function switchAuthTab(tab) {
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
            
            if (tab === 'login') {
                document.querySelector('.auth-tab:first-child').classList.add('active');
                document.getElementById('login-form').classList.add('active');
            } else {
                document.querySelector('.auth-tab:last-child').classList.add('active');
                document.getElementById('register-form').classList.add('active');
            }
            hideAuthError();
        }
        
        function toggleRegisterType() {
            const type = document.getElementById('register-type').value;
            document.getElementById('new-tenant-fields').style.display = type === 'new' ? 'block' : 'none';
            document.getElementById('join-tenant-fields').style.display = type === 'join' ? 'block' : 'none';
        }
        
        function showAuthError(msg) {
            const el = document.getElementById('auth-error');
            el.textContent = msg;
            el.classList.add('show');
        }
        
        function hideAuthError() {
            document.getElementById('auth-error').classList.remove('show');
        }
        
        async function handleLogin(e) {
            e.preventDefault();
            hideAuthError();
            
            const email = document.getElementById('login-email').value.trim();
            const password = document.getElementById('login-password').value;
            const btn = document.getElementById('login-btn');
            
            btn.disabled = true;
            btn.textContent = 'ë¡œê·¸ì¸ ì¤‘...';
            
            try {
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                // Auth state observerê°€ ì²˜ë¦¬
            } catch (error) {
                let msg = 'ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
                if (error.code === 'auth/user-not-found') msg = 'ë“±ë¡ë˜ì§€ ì•Šì€ ì´ë©”ì¼ì…ë‹ˆë‹¤.';
                else if (error.code === 'auth/wrong-password') msg = 'ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.';
                else if (error.code === 'auth/invalid-email') msg = 'ìœ íš¨í•˜ì§€ ì•Šì€ ì´ë©”ì¼ í˜•ì‹ì…ë‹ˆë‹¤.';
                else if (error.code === 'auth/too-many-requests') msg = 'ë„ˆë¬´ ë§ì€ ì‹œë„ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.';
                showAuthError(msg);
            } finally {
                btn.disabled = false;
                btn.textContent = 'ë¡œê·¸ì¸';
            }
        }
        
        async function handleRegister(e) {
            e.preventDefault();
            hideAuthError();
            
            const type = document.getElementById('register-type').value;
            const name = document.getElementById('register-name').value.trim();
            const email = document.getElementById('register-email').value.trim();
            const password = document.getElementById('register-password').value;
            const passwordConfirm = document.getElementById('register-password-confirm').value;
            const btn = document.getElementById('register-btn');
            
            // ìœ íš¨ì„± ê²€ì‚¬
            if (!name) { showAuthError('ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
            if (password !== passwordConfirm) { showAuthError('ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.'); return; }
            if (password.length < 6) { showAuthError('ë¹„ë°€ë²ˆí˜¸ëŠ” 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.'); return; }
            
            let tenantId, tenantName, role;
            
            if (type === 'new') {
                // ì‹ ê·œ ê³ ê°ì‚¬ ë“±ë¡
                const hotelName = document.getElementById('register-hotel-name').value.trim();
                if (!hotelName) { showAuthError('í˜¸í…”/ì—…ì²´ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
                tenantName = hotelName;
                role = 'admin';
            } else {
                // ê¸°ì¡´ ê³ ê°ì‚¬ ì°¸ì—¬
                const tenantCode = document.getElementById('register-tenant-code').value.trim().toUpperCase();
                if (!tenantCode) { showAuthError('ê³ ê°ì‚¬ ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
                
                // í…Œë„ŒíŠ¸ ì½”ë“œ í™•ì¸
                try {
                    const tenantQuery = await db.collection('tenants').where('inviteCode', '==', tenantCode).get();
                    if (tenantQuery.empty) {
                        showAuthError('ìœ íš¨í•˜ì§€ ì•Šì€ ê³ ê°ì‚¬ ì½”ë“œì…ë‹ˆë‹¤.');
                        return;
                    }
                    const tenantDoc = tenantQuery.docs[0];
                    tenantId = tenantDoc.id;
                    tenantName = tenantDoc.data().name;
                    role = 'staff';
                } catch (err) {
                    showAuthError('ê³ ê°ì‚¬ ì½”ë“œ í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                    return;
                }
            }
            
            btn.disabled = true;
            btn.textContent = 'ê°€ì… ì²˜ë¦¬ ì¤‘...';
            
            try {
                // Firebase Auth ê³„ì • ìƒì„±
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;
                
                // ì‹ ê·œ ê³ ê°ì‚¬ì¸ ê²½ìš° í…Œë„ŒíŠ¸ ìƒì„±
                if (type === 'new') {
                    const inviteCode = generateInviteCode();
                    const tenantRef = await db.collection('tenants').add({
                        name: tenantName,
                        inviteCode: inviteCode,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        createdBy: user.uid
                    });
                    tenantId = tenantRef.id;
                    
                    // ê¸°ë³¸ í˜¸í…” ì •ë³´ ì´ˆê¸°í™”
                    await db.collection('tenants').doc(tenantId).collection('data').doc('hotelInfo').set({
                        name: tenantName,
                        totalRooms: 100,
                        floors: 10,
                        roomTypes: [{ name: 'ìŠ¤íƒ ë‹¤ë“œ', price: 100000 }, { name: 'ë””ëŸ­ìŠ¤', price: 150000 }],
                        facilities: [],
                        minSalesTarget: 0
                    });
                }
                
                // ì‚¬ìš©ì ì •ë³´ ì €ì¥
                await db.collection('users').doc(user.uid).set({
                    name: name,
                    email: email,
                    tenantId: tenantId,
                    role: role,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    status: 'active'
                });
                
                showToast('íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                // Auth state observerê°€ ë‚˜ë¨¸ì§€ ì²˜ë¦¬
                
            } catch (error) {
                let msg = 'íšŒì›ê°€ì…ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
                if (error.code === 'auth/email-already-in-use') msg = 'ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì´ë©”ì¼ì…ë‹ˆë‹¤.';
                else if (error.code === 'auth/invalid-email') msg = 'ìœ íš¨í•˜ì§€ ì•Šì€ ì´ë©”ì¼ í˜•ì‹ì…ë‹ˆë‹¤.';
                else if (error.code === 'auth/weak-password') msg = 'ë¹„ë°€ë²ˆí˜¸ê°€ ë„ˆë¬´ ì•½í•©ë‹ˆë‹¤.';
                showAuthError(msg);
            } finally {
                btn.disabled = false;
                btn.textContent = 'íšŒì›ê°€ì…';
            }
        }
        
        function generateInviteCode() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let code = '';
            for (let i = 0; i < 8; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }
        
        async function handleLogout() {
            if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                // ë¦¬ìŠ¤ë„ˆ í•´ì œ
                unsubscribeListeners.forEach(unsub => unsub());
                unsubscribeListeners = [];
                
                await auth.signOut();
                currentUser = null;
                currentTenant = null;
                
                document.getElementById('auth-overlay').classList.remove('hidden');
                showToast('ë¡œê·¸ì•„ì›ƒë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
            }
        }
        
        function copyTenantCode() {
            const code = currentTenant?.inviteCode || '-';
            if (code !== '-') {
                navigator.clipboard.writeText(code).then(() => {
                    showToast('ì´ˆëŒ€ ì½”ë“œê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤: ' + code, 'success');
                });
            }
        }
        
        // ============================================================
        // Auth State Observer
        // ============================================================
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                showLoading();
                try {
                    // ì‚¬ìš©ì ì •ë³´ ë¡œë“œ
                    const userDoc = await db.collection('users').doc(user.uid).get();
                    if (!userDoc.exists) {
                        showToast('ì‚¬ìš©ì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                        await auth.signOut();
                        hideLoading();
                        return;
                    }
                    
                    const userData = userDoc.data();
                    currentUser = { uid: user.uid, ...userData };
                    currentUserRole = userData.role || 'staff';
                    
                    // í…Œë„ŒíŠ¸ ì •ë³´ ë¡œë“œ
                    const tenantDoc = await db.collection('tenants').doc(userData.tenantId).get();
                    if (!tenantDoc.exists) {
                        showToast('ê³ ê°ì‚¬ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                        await auth.signOut();
                        hideLoading();
                        return;
                    }
                    
                    currentTenant = { id: tenantDoc.id, ...tenantDoc.data() };
                    
                    // UI ì—…ë°ì´íŠ¸
                    updateSidebarUserInfo();
                    setupDataListeners();
                    
                    // ê´€ë¦¬ì ë©”ë‰´ í‘œì‹œ
                    if (currentUserRole === 'admin') {
                        document.getElementById('nav-users').style.display = 'block';
                        document.getElementById('tenant-info-card').style.display = 'block';
                        document.getElementById('admin-settings-card').style.display = 'block';
                    }
                    
                    // ì¸ì¦ í™”ë©´ ìˆ¨ê¸°ê¸°
                    document.getElementById('auth-overlay').classList.add('hidden');
                    
                    // ì´ˆê¸°í™”
                    initApp();
                    
                } catch (error) {
                    console.error('User load error:', error);
                    showToast('ë°ì´í„° ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                }
                hideLoading();
            } else {
                // ë¡œê·¸ì•„ì›ƒ ìƒíƒœ
                document.getElementById('auth-overlay').classList.remove('hidden');
            }
        });
        
        function updateSidebarUserInfo() {
            document.getElementById('sidebar-tenant-name').textContent = currentTenant?.name || '-';
            document.getElementById('sidebar-user-email').textContent = currentUser?.email || '-';
            document.getElementById('sidebar-user-role').textContent = currentUserRole === 'admin' ? 'ê´€ë¦¬ì' : 'ì§ì›';
            
            // í…Œë„ŒíŠ¸ ì •ë³´ ì¹´ë“œ
            document.getElementById('display-tenant-id').textContent = currentTenant?.id || '-';
            document.getElementById('display-tenant-code').textContent = currentTenant?.inviteCode || '-';
            
            // ì„¤ì • í˜ì´ì§€
            document.getElementById('settings-tenant-id').textContent = currentTenant?.id || '-';
            document.getElementById('settings-tenant-code').textContent = currentTenant?.inviteCode || '-';
            
            // ì‚¬ìš©ì ê´€ë¦¬ í˜ì´ì§€
            document.getElementById('users-tenant-name').textContent = currentTenant?.name || '-';
            document.getElementById('users-tenant-code').textContent = currentTenant?.inviteCode || '-';
        }
        // ============================================================
        // Firestore ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ
        // ============================================================
        function setupDataListeners() {
            if (!currentTenant?.id) return;
            
            const tenantRef = db.collection('tenants').doc(currentTenant.id);
            
            // í˜¸í…” ì •ë³´ ë¦¬ìŠ¤ë„ˆ
            const unsubHotel = tenantRef.collection('data').doc('hotelInfo')
                .onSnapshot(doc => {
                    if (doc.exists) {
                        appData.hotelInfo = { ...appData.hotelInfo, ...doc.data() };
                        renderHotelInfo();
                        updateDashboard();
                    }
                    updateSyncStatus('synced');
                }, err => {
                    console.error('Hotel info listener error:', err);
                    updateSyncStatus('offline');
                });
            unsubscribeListeners.push(unsubHotel);
            
            // ë§¤ì¶œ ë¦¬ìŠ¤ë„ˆ
            const unsubSales = tenantRef.collection('sales')
                .orderBy('date', 'desc')
                .onSnapshot(snapshot => {
                    appData.sales = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    updateSalesList();
                    updateDashboard();
                    renderKPIAnalysis();
                    updateSyncStatus('synced');
                }, err => {
                    console.error('Sales listener error:', err);
                    updateSyncStatus('offline');
                });
            unsubscribeListeners.push(unsubSales);
            
            // OTA ë¦¬ìŠ¤ë„ˆ
            const unsubOtas = tenantRef.collection('otas')
                .onSnapshot(snapshot => {
                    appData.otas = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    updateOTAList();
                    updateOTASelects();
                    updateSyncStatus('synced');
                });
            unsubscribeListeners.push(unsubOtas);
            
            // í”„ë¡œëª¨ì…˜ ë¦¬ìŠ¤ë„ˆ
            const unsubPromos = tenantRef.collection('promotions')
                .onSnapshot(snapshot => {
                    appData.promotions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderPromotionList();
                    updateSyncStatus('synced');
                });
            unsubscribeListeners.push(unsubPromos);
            
            // ì‚¬ìš©ì ëª©ë¡ ë¦¬ìŠ¤ë„ˆ (ê´€ë¦¬ìë§Œ)
            if (currentUserRole === 'admin') {
                const unsubUsers = db.collection('users')
                    .where('tenantId', '==', currentTenant.id)
                    .onSnapshot(snapshot => {
                        renderUsersList(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                    });
                unsubscribeListeners.push(unsubUsers);
            }
        }
        
        function updateSyncStatus(status) {
            const indicator = document.getElementById('sync-indicator');
            const text = document.getElementById('sync-text');
            
            indicator.className = 'sync-indicator ' + status;
            if (status === 'synced') text.textContent = 'ë™ê¸°í™” ì™„ë£Œ';
            else if (status === 'syncing') text.textContent = 'ë™ê¸°í™” ì¤‘...';
            else text.textContent = 'ì˜¤í”„ë¼ì¸';
        }
        
        // ============================================================
        // ì´ˆê¸°í™” ë° ìœ í‹¸ë¦¬í‹°
        // ============================================================
        function initApp() {
            // ë‚ ì§œ í‘œì‹œ
            const today = new Date();
            document.getElementById('today-date').textContent = today.toLocaleDateString('ko-KR', {
                year: 'numeric', month: 'long', day: 'numeric', weekday: 'short'
            });
            
            // ê¸°ë³¸ ë‚ ì§œ ì„¤ì •
            const todayStr = today.toISOString().split('T')[0];
            ['sales-date', 'expense-date', 'report-date'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.value = todayStr;
            });
            
            // ì•„ì´ì½˜ ì´ˆê¸°í™”
            if (typeof lucide !== 'undefined') lucide.createIcons();
            
            // ì´ˆê¸° ë Œë”ë§
            renderHotelInfo();
            updateDashboard();
            renderMonthlyCalendar();
        }
        
        function showLoading() { document.getElementById('loading-overlay').classList.add('active'); }
        function hideLoading() { document.getElementById('loading-overlay').classList.remove('active'); }
        
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'toast ' + type;
            toast.innerHTML = '<span>' + message + '</span>';
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 4000);
        }
        
        function formatCurrency(n) { return 'â‚©' + (n || 0).toLocaleString('ko-KR'); }
        function formatNumber(n) { return (n || 0).toLocaleString('ko-KR'); }
        function formatPercent(n) { return (n || 0).toFixed(1) + '%'; }
        
        function showModal(title, bodyHtml, footerHtml = '') {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-body').innerHTML = bodyHtml;
            document.getElementById('modal-footer').innerHTML = footerHtml;
            document.getElementById('custom-modal').classList.add('active');
        }
        
        function closeModal() { document.getElementById('custom-modal').classList.remove('active'); }
        
        // ============================================================
        // ì„¹ì…˜ ì „í™˜
        // ============================================================
        function showSection(sectionId, el) {
            document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');
            
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            if (el) el.classList.add('active');
            
            const titles = {
                'hotel-info': 'í˜¸í…”ì •ë³´', 'dashboard': 'ëŒ€ì‹œë³´ë“œ', 'sales': 'ë§¤ì¶œ / ì§€ì¶œ',
                'monthly-calendar': 'ì›”ë³„ ë§¤ì¶œê´€ë¦¬', 'ota': 'OTA / ìˆ˜ìˆ˜ë£Œ ë¶„ì„', 'promotion': 'í”„ë¡œëª¨ì…˜',
                'kpi': 'KPI ë¶„ì„', 'ai-assistant': 'AI ì»¨ì„¤í„´íŠ¸', 'report': 'ë³´ê³ ì„œ',
                'users': 'ì‚¬ìš©ì ê´€ë¦¬', 'settings': 'ì„¤ì •', 'help': 'ë„ì›€ë§'
            };
            document.getElementById('current-section-title').textContent = titles[sectionId] || sectionId;
            
            // ì„¹ì…˜ë³„ ì—…ë°ì´íŠ¸
            if (sectionId === 'dashboard') { updateDashboard(); renderDashboardCharts(); }
            else if (sectionId === 'sales') { updateSalesList(); updateOTASelects(); }
            else if (sectionId === 'monthly-calendar') { renderMonthlyCalendar(); }
            else if (sectionId === 'ota') { updateOTAList(); renderCRRChart(); }
            else if (sectionId === 'promotion') { renderPromotionList(); renderPromoCalendar(); }
            else if (sectionId === 'kpi') { renderKPIAnalysis(); }
            
            // ëª¨ë°”ì¼ ì‚¬ì´ë“œë°” ë‹«ê¸°
            document.getElementById('sidebar').classList.remove('mobile-open');
            
            if (typeof lucide !== 'undefined') lucide.createIcons();
            window.scrollTo(0, 0);
        }
        
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('hidden');
            document.getElementById('main-content').classList.toggle('full-width');
        }
        
        function toggleMobileSidebar() {
            document.getElementById('sidebar').classList.toggle('mobile-open');
        }
        
        // ============================================================
        // í˜¸í…” ì •ë³´ ê´€ë¦¬
        // ============================================================
        function renderHotelInfo() {
            const info = appData.hotelInfo;
            document.getElementById('hotel-name').value = info.name || '';
            document.getElementById('total-rooms').value = info.totalRooms || '';
            document.getElementById('floors').value = info.floors || '';
            document.getElementById('min-sales-target').value = info.minSalesTarget || '';
            document.getElementById('avg-sales').value = info.avgSales || '';
            document.getElementById('avg-rooms-sold').value = info.avgRoomsSold || '';
            document.getElementById('avg-occupancy').value = info.avgOccupancy || '';
            
            renderRoomTypesList();
            renderFacilitiesList();
            updateRoomTypeSelect();
            updateFacilitySelect();
        }
        
        async function saveHotelInfo() {
            if (!currentTenant?.id) { showToast('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.', 'error'); return; }
            
            updateSyncStatus('syncing');
            
            const info = {
                name: document.getElementById('hotel-name').value,
                totalRooms: parseInt(document.getElementById('total-rooms').value) || 100,
                floors: parseInt(document.getElementById('floors').value) || 10,
                minSalesTarget: parseFloat(document.getElementById('min-sales-target').value) || 0,
                avgSales: parseFloat(document.getElementById('avg-sales').value) || 0,
                avgRoomsSold: parseInt(document.getElementById('avg-rooms-sold').value) || 0,
                avgOccupancy: parseFloat(document.getElementById('avg-occupancy').value) || 0,
                roomTypes: appData.hotelInfo.roomTypes || [],
                facilities: appData.hotelInfo.facilities || []
            };
            
            try {
                await db.collection('tenants').doc(currentTenant.id)
                    .collection('data').doc('hotelInfo').set(info, { merge: true });
                showToast('í˜¸í…” ì •ë³´ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            } catch (err) {
                console.error('Save hotel info error:', err);
                showToast('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }
        
        function renderRoomTypesList() {
            const list = document.getElementById('room-types-list');
            const types = appData.hotelInfo.roomTypes || [];
            
            list.innerHTML = types.map((rt, i) => `
                <div style="display:grid; grid-template-columns:1fr 1fr 40px; gap:10px; margin-bottom:10px;">
                    <input type="text" value="${rt.name || ''}" placeholder="íƒ€ì…ëª…" onchange="updateRoomType(${i}, 'name', this.value)">
                    <input type="number" value="${rt.price || 0}" placeholder="ë‹¨ê°€" onchange="updateRoomType(${i}, 'price', this.value)">
                    <button class="btn btn-danger" style="padding:8px;" onclick="removeRoomType(${i})">âœ•</button>
                </div>
            `).join('') || '<p style="color: var(--text-muted); font-size: 0.9rem;">ê°ì‹¤ íƒ€ì…ì„ ì¶”ê°€í•˜ì„¸ìš”.</p>';
        }
        
        function addRoomTypeRow() {
            if (!appData.hotelInfo.roomTypes) appData.hotelInfo.roomTypes = [];
            appData.hotelInfo.roomTypes.push({ name: '', price: 0 });
            renderRoomTypesList();
        }
        
        function updateRoomType(i, key, val) {
            appData.hotelInfo.roomTypes[i][key] = key === 'price' ? Number(val) : val;
            updateRoomTypeSelect();
        }
        
        function removeRoomType(i) {
            appData.hotelInfo.roomTypes.splice(i, 1);
            renderRoomTypesList();
            updateRoomTypeSelect();
        }
        
        function renderFacilitiesList() {
            const list = document.getElementById('facilities-list');
            const facilities = appData.hotelInfo.facilities || [];
            
            list.innerHTML = facilities.map((f, i) => `
                <div style="display:grid; grid-template-columns:1fr 1fr 40px; gap:10px; margin-bottom:10px;">
                    <input type="text" value="${f.name || ''}" placeholder="ì‹œì„¤ëª…" onchange="updateFacility(${i}, 'name', this.value)">
                    <input type="number" value="${f.price || 0}" placeholder="ë‹¨ê°€" onchange="updateFacility(${i}, 'price', this.value)">
                    <button class="btn btn-danger" style="padding:8px;" onclick="removeFacility(${i})">âœ•</button>
                </div>
            `).join('') || '<p style="color: var(--text-muted); font-size: 0.9rem;">ë¶€ëŒ€ì‹œì„¤ì„ ì¶”ê°€í•˜ì„¸ìš”.</p>';
        }
        
        function addFacilityRow() {
            if (!appData.hotelInfo.facilities) appData.hotelInfo.facilities = [];
            appData.hotelInfo.facilities.push({ name: '', price: 0 });
            renderFacilitiesList();
        }
        
        function updateFacility(i, key, val) {
            appData.hotelInfo.facilities[i][key] = key === 'price' ? Number(val) : val;
            updateFacilitySelect();
        }
        
        function removeFacility(i) {
            appData.hotelInfo.facilities.splice(i, 1);
            renderFacilitiesList();
            updateFacilitySelect();
        }
        // ============================================================
        // ë§¤ì¶œ/ì§€ì¶œ ê´€ë¦¬
        // ============================================================
        function onSalesChannelChange() {
            const channel = document.getElementById('sales-channel').value;
            document.getElementById('ota-category-group').style.display = channel === 'ota' ? 'block' : 'none';
            document.getElementById('room-type-group').style.display = ['room', 'ota', 'direct', 'group'].includes(channel) ? 'block' : 'none';
            document.getElementById('facility-group').style.display = channel === 'facility' ? 'block' : 'none';
        }
        
        function updateRoomTypeSelect() {
            const select = document.getElementById('room-type-select');
            if (!select) return;
            const types = appData.hotelInfo.roomTypes || [];
            select.innerHTML = '<option value="">ì„ íƒ</option>' + 
                types.map(rt => `<option value="${rt.name}" data-price="${rt.price}">${rt.name} (${formatCurrency(rt.price)})</option>`).join('');
        }
        
        function updateFacilitySelect() {
            const select = document.getElementById('facility-select');
            if (!select) return;
            const facilities = appData.hotelInfo.facilities || [];
            select.innerHTML = '<option value="">ì„ íƒ</option>' + 
                facilities.map(f => `<option value="${f.name}" data-price="${f.price}">${f.name} (${formatCurrency(f.price)})</option>`).join('');
        }
        
        function updateOTASelects() {
            const selects = ['ota-category'];
            selects.forEach(id => {
                const select = document.getElementById(id);
                if (!select) return;
                select.innerHTML = '<option value="">ì„ íƒ</option>' + 
                    appData.otas.map(o => `<option value="${o.name}" data-rate="${o.feeRate}">${o.name} (${o.feeRate}%)</option>`).join('');
            });
        }
        
        function onRoomTypeSelect() {
            const select = document.getElementById('room-type-select');
            const option = select.options[select.selectedIndex];
            if (option && option.dataset.price) {
                document.getElementById('room-unit-price').value = option.dataset.price;
                calcSalesAmount();
            }
        }
        
        function onFacilitySelect() {
            const select = document.getElementById('facility-select');
            const option = select.options[select.selectedIndex];
            if (option && option.dataset.price) {
                document.getElementById('room-unit-price').value = option.dataset.price;
                calcSalesAmount();
            }
        }
        
        function calcSalesAmount() {
            const qty = parseInt(document.getElementById('room-count').value) || 1;
            const price = parseFloat(document.getElementById('room-unit-price').value) || 0;
            document.getElementById('sales-amount').value = qty * price;
            
            // OTA ìˆ˜ìˆ˜ë£Œ ìë™ ê³„ì‚°
            const channel = document.getElementById('sales-channel').value;
            if (channel === 'ota') {
                const otaSelect = document.getElementById('ota-category');
                const option = otaSelect.options[otaSelect.selectedIndex];
                if (option && option.dataset.rate) {
                    const fee = Math.round(qty * price * parseFloat(option.dataset.rate) / 100);
                    document.getElementById('sales-fee').value = fee;
                }
            }
        }
        
        async function addRevenueEntry() {
            if (!currentTenant?.id) { showToast('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.', 'error'); return; }
            
            const date = document.getElementById('sales-date').value;
            const channel = document.getElementById('sales-channel').value;
            const amount = parseFloat(document.getElementById('sales-amount').value) || 0;
            const fee = parseFloat(document.getElementById('sales-fee').value) || 0;
            const note = document.getElementById('sales-note').value;
            const qty = parseInt(document.getElementById('room-count').value) || 1;
            const unitPrice = parseFloat(document.getElementById('room-unit-price').value) || 0;
            
            if (!date || amount <= 0) {
                showToast('ë‚ ì§œì™€ ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'warning');
                return;
            }
            
            const entry = {
                type: 'revenue',
                date: date,
                channel: channel,
                amount: amount,
                fee: fee,
                qty: qty,
                unitPrice: unitPrice,
                note: note,
                roomType: document.getElementById('room-type-select')?.value || '',
                otaName: channel === 'ota' ? document.getElementById('ota-category')?.value : '',
                facilityName: channel === 'facility' ? document.getElementById('facility-select')?.value : '',
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                createdBy: currentUser?.uid
            };
            
            updateSyncStatus('syncing');
            
            try {
                await db.collection('tenants').doc(currentTenant.id).collection('sales').add(entry);
                showToast('ë§¤ì¶œì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                
                // í¼ ì´ˆê¸°í™”
                document.getElementById('sales-amount').value = '';
                document.getElementById('sales-fee').value = '0';
                document.getElementById('sales-note').value = '';
                document.getElementById('room-count').value = '1';
                document.getElementById('room-unit-price').value = '';
            } catch (err) {
                console.error('Add revenue error:', err);
                showToast('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }
        
        async function addExpenseEntry() {
            if (!currentTenant?.id) { showToast('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.', 'error'); return; }
            
            const date = document.getElementById('expense-date').value;
            const category = document.getElementById('expense-category').value;
            const amount = parseFloat(document.getElementById('expense-amount').value) || 0;
            const note = document.getElementById('expense-note').value;
            
            if (!date || amount <= 0) {
                showToast('ë‚ ì§œì™€ ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'warning');
                return;
            }
            
            const entry = {
                type: 'expense',
                date: date,
                channel: 'expense',
                category: category,
                amount: amount,
                fee: 0,
                note: note,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                createdBy: currentUser?.uid
            };
            
            updateSyncStatus('syncing');
            
            try {
                await db.collection('tenants').doc(currentTenant.id).collection('sales').add(entry);
                showToast('ì§€ì¶œì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                document.getElementById('expense-amount').value = '';
                document.getElementById('expense-note').value = '';
            } catch (err) {
                console.error('Add expense error:', err);
                showToast('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }
        
        function updateSalesList() {
            const tbody = document.getElementById('sales-list-body');
            if (!tbody) return;
            
            let filtered = [...appData.sales];
            if (salesFilter.start) filtered = filtered.filter(s => s.date >= salesFilter.start);
            if (salesFilter.end) filtered = filtered.filter(s => s.date <= salesFilter.end);
            
            const channelNames = { room: 'ê°ì‹¤', ota: 'OTA', direct: 'ì§ì ‘ì˜ˆì•½', group: 'ë‹¨ì²´', facility: 'ë¶€ëŒ€ì‹œì„¤', expense: 'ì§€ì¶œ', other: 'ê¸°íƒ€' };
            const expenseNames = { labor: 'ì¸ê±´ë¹„', utility: 'ê³µê³¼ê¸ˆ', maintenance: 'ìœ ì§€ë³´ìˆ˜', marketing: 'ë§ˆì¼€íŒ…', supplies: 'ì†Œëª¨í’ˆ', other: 'ê¸°íƒ€' };
            
            tbody.innerHTML = filtered.slice(0, 100).map(s => {
                const isExpense = s.type === 'expense';
                const channelName = channelNames[s.channel] || s.channel;
                const itemName = isExpense ? (expenseNames[s.category] || s.category) : (s.roomType || s.facilityName || s.otaName || '-');
                const netAmount = isExpense ? -s.amount : (s.amount - (s.fee || 0));
                
                return `<tr>
                    <td>${s.date}</td>
                    <td><span style="color: ${isExpense ? 'var(--danger)' : 'var(--success)'}; font-weight: 600;">${isExpense ? 'ì§€ì¶œ' : 'ë§¤ì¶œ'}</span></td>
                    <td>${channelName}</td>
                    <td>${itemName}</td>
                    <td>${s.qty || 1}</td>
                    <td>${formatCurrency(s.amount)}</td>
                    <td>${formatCurrency(s.fee || 0)}</td>
                    <td style="color: ${netAmount >= 0 ? 'var(--success)' : 'var(--danger)'}; font-weight: 600;">${formatCurrency(netAmount)}</td>
                    <td>${s.note || '-'}</td>
                    <td><button class="btn btn-danger" style="padding:5px 10px; font-size:0.8rem;" onclick="deleteSale('${s.id}')">ì‚­ì œ</button></td>
                </tr>`;
            }).join('') || '<tr><td colspan="10" style="text-align:center; color:var(--text-muted);">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
        }
        
        function filterSalesList() {
            salesFilter.start = document.getElementById('filter-start').value || null;
            salesFilter.end = document.getElementById('filter-end').value || null;
            updateSalesList();
        }
        
        function clearSalesFilter() {
            salesFilter = { start: null, end: null };
            document.getElementById('filter-start').value = '';
            document.getElementById('filter-end').value = '';
            updateSalesList();
        }
        
        async function deleteSale(id) {
            if (!confirm('ì´ í•­ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            
            try {
                await db.collection('tenants').doc(currentTenant.id).collection('sales').doc(id).delete();
                showToast('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            } catch (err) {
                console.error('Delete error:', err);
                showToast('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }
        
        // ============================================================
        // OTA ê´€ë¦¬
        // ============================================================
        async function addOTA() {
            if (!currentTenant?.id) { showToast('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.', 'error'); return; }
            
            const name = document.getElementById('ota-name').value.trim();
            const feeRate = parseFloat(document.getElementById('ota-fee-rate').value) || 0;
            
            if (!name) { showToast('OTAëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'warning'); return; }
            
            try {
                await db.collection('tenants').doc(currentTenant.id).collection('otas').add({
                    name: name,
                    feeRate: feeRate,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                showToast('OTAê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                document.getElementById('ota-name').value = '';
                document.getElementById('ota-fee-rate').value = '';
            } catch (err) {
                console.error('Add OTA error:', err);
                showToast('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }
        
        function updateOTAList() {
            const tbody = document.getElementById('ota-list-body');
            if (!tbody) return;
            
            // OTAë³„ ë§¤ì¶œ ì§‘ê³„
            const otaSales = {};
            appData.sales.filter(s => s.type === 'revenue' && s.channel === 'ota').forEach(s => {
                const name = s.otaName || 'Unknown';
                if (!otaSales[name]) otaSales[name] = { total: 0, fee: 0 };
                otaSales[name].total += s.amount || 0;
                otaSales[name].fee += s.fee || 0;
            });
            
            tbody.innerHTML = appData.otas.map(ota => {
                const sales = otaSales[ota.name] || { total: 0, fee: 0 };
                const actualCRR = sales.total > 0 ? (sales.fee / sales.total * 100) : 0;
                
                return `<tr>
                    <td>${ota.name}</td>
                    <td>${ota.feeRate}%</td>
                    <td>${formatCurrency(sales.total)}</td>
                    <td>${formatCurrency(sales.fee)}</td>
                    <td><span style="color: ${actualCRR > ota.feeRate ? 'var(--danger)' : 'var(--success)'}; font-weight:600;">${actualCRR.toFixed(1)}%</span></td>
                    <td><button class="btn btn-danger" style="padding:5px 10px; font-size:0.8rem;" onclick="deleteOTA('${ota.id}')">ì‚­ì œ</button></td>
                </tr>`;
            }).join('') || '<tr><td colspan="6" style="text-align:center; color:var(--text-muted);">ë“±ë¡ëœ OTAê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
            
            updateAIFeeGuide();
        }
        
        async function deleteOTA(id) {
            if (!confirm('ì´ OTAë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            
            try {
                await db.collection('tenants').doc(currentTenant.id).collection('otas').doc(id).delete();
                showToast('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            } catch (err) {
                showToast('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }
        // ============================================================
        // ëŒ€ì‹œë³´ë“œ
        // ============================================================
        function updateDashboard() {
            const now = new Date();
            const month = now.getMonth();
            const year = now.getFullYear();
            
            // ì´ë²ˆ ë‹¬ ë°ì´í„° í•„í„°
            const thisMonthSales = appData.sales.filter(s => {
                const d = new Date(s.date);
                return d.getMonth() === month && d.getFullYear() === year;
            });
            
            const revenues = thisMonthSales.filter(s => s.type === 'revenue');
            const expenses = thisMonthSales.filter(s => s.type === 'expense');
            
            const totalRevenue = revenues.reduce((sum, s) => sum + (s.amount || 0), 0);
            const totalFee = revenues.reduce((sum, s) => sum + (s.fee || 0), 0);
            const totalExpense = expenses.reduce((sum, s) => sum + (s.amount || 0), 0);
            const netSales = totalRevenue - totalFee - totalExpense;
            
            // ê°ì‹¤ íŒë§¤ ìˆ˜ëŸ‰
            const roomSales = revenues.filter(s => ['room', 'ota', 'direct', 'group'].includes(s.channel));
            const roomsSold = roomSales.reduce((sum, s) => sum + (s.qty || 1), 0);
            const totalRooms = appData.hotelInfo.totalRooms || 100;
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const daysPassed = now.getDate();
            const occupancy = (roomsSold / (totalRooms * daysPassed)) * 100;
            
            // í‘œì‹œ
            document.getElementById('dashboard-net-sales').textContent = formatCurrency(netSales);
            document.getElementById('dashboard-total-sales').textContent = formatCurrency(totalRevenue);
            document.getElementById('dashboard-ota-fee').textContent = formatCurrency(totalFee);
            document.getElementById('dashboard-occupancy').textContent = formatPercent(occupancy);
            
            // ëª©í‘œ ëŒ€ë¹„
            const target = appData.hotelInfo.minSalesTarget || 0;
            if (target > 0) {
                const progress = (totalRevenue / target * 100);
                document.getElementById('dashboard-net-sales-change').textContent = `ëª©í‘œ ëŒ€ë¹„ ${progress.toFixed(0)}%`;
                document.getElementById('dashboard-net-sales-change').className = 'stat-change ' + (progress >= 100 ? 'positive' : 'negative');
            }
            
            // ìµœê·¼ ê±°ë˜
            updateRecentTransactions();
        }
        
        function updateRecentTransactions() {
            const tbody = document.getElementById('recent-transactions');
            if (!tbody) return;
            
            const recent = [...appData.sales].sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 10);
            const channelNames = { room: 'ê°ì‹¤', ota: 'OTA', direct: 'ì§ì ‘', group: 'ë‹¨ì²´', facility: 'ë¶€ëŒ€ì‹œì„¤', expense: 'ì§€ì¶œ', other: 'ê¸°íƒ€' };
            
            tbody.innerHTML = recent.map(s => {
                const isExpense = s.type === 'expense';
                return `<tr>
                    <td>${s.date}</td>
                    <td style="color: ${isExpense ? 'var(--danger)' : 'var(--success)'}">${isExpense ? 'ì§€ì¶œ' : 'ë§¤ì¶œ'}</td>
                    <td>${channelNames[s.channel] || s.channel}</td>
                    <td>${s.roomType || s.facilityName || s.category || '-'}</td>
                    <td>${formatCurrency(s.amount)}</td>
                    <td>${formatCurrency(s.fee || 0)}</td>
                    <td>${s.note || '-'}</td>
                </tr>`;
            }).join('') || '<tr><td colspan="7" style="text-align:center;">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
        }
        
        function renderDashboardCharts() {
            renderSalesTrendChart();
            renderChannelPieChart();
        }
        
        function renderSalesTrendChart() {
            const canvas = document.getElementById('sales-trend-chart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const period = document.getElementById('chart-period')?.value || 'monthly';
            
            let labels = [], values = [];
            const now = new Date();
            
            if (period === 'daily') {
                for (let i = 6; i >= 0; i--) {
                    const d = new Date(now); d.setDate(d.getDate() - i);
                    const dateStr = d.toISOString().split('T')[0];
                    labels.push((d.getMonth()+1) + '/' + d.getDate());
                    const dayTotal = appData.sales.filter(s => s.type === 'revenue' && s.date === dateStr)
                        .reduce((sum, s) => sum + (s.amount || 0), 0);
                    values.push(dayTotal);
                }
            } else if (period === 'weekly') {
                for (let i = 3; i >= 0; i--) {
                    const weekEnd = new Date(now); weekEnd.setDate(weekEnd.getDate() - (i * 7));
                    const weekStart = new Date(weekEnd); weekStart.setDate(weekStart.getDate() - 6);
                    labels.push(`${weekStart.getMonth()+1}/${weekStart.getDate()}~`);
                    const weekTotal = appData.sales.filter(s => {
                        const sd = new Date(s.date);
                        return s.type === 'revenue' && sd >= weekStart && sd <= weekEnd;
                    }).reduce((sum, s) => sum + (s.amount || 0), 0);
                    values.push(weekTotal);
                }
            } else {
                for (let i = 5; i >= 0; i--) {
                    const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
                    labels.push((d.getMonth()+1) + 'ì›”');
                    const monthTotal = appData.sales.filter(s => {
                        const sd = new Date(s.date);
                        return s.type === 'revenue' && sd.getMonth() === d.getMonth() && sd.getFullYear() === d.getFullYear();
                    }).reduce((sum, s) => sum + (s.amount || 0), 0);
                    values.push(monthTotal);
                }
            }
            
            if (charts.salesTrend) charts.salesTrend.destroy();
            charts.salesTrend = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'ë§¤ì¶œ',
                        data: values,
                        backgroundColor: 'rgba(54, 184, 237, 0.7)',
                        borderColor: 'rgba(54, 184, 237, 1)',
                        borderWidth: 1,
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true, ticks: { callback: v => (v/10000) + 'ë§Œ' } } }
                }
            });
        }
        
        function renderChannelPieChart() {
            const canvas = document.getElementById('channel-pie-chart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const now = new Date();
            const revenues = appData.sales.filter(s => s.type === 'revenue' && new Date(s.date).getMonth() === now.getMonth());
            
            const byChannel = { room: 0, ota: 0, direct: 0, group: 0, facility: 0, other: 0 };
            revenues.forEach(s => {
                const ch = s.channel || 'other';
                byChannel[ch] = (byChannel[ch] || 0) + (s.amount || 0);
            });
            
            const labels = [], data = [], colors = ['#36B8ED', '#10b981', '#f59e0b', '#8b5cf6', '#ec4899', '#6b7280'];
            const names = { room: 'ê°ì‹¤', ota: 'OTA', direct: 'ì§ì ‘ì˜ˆì•½', group: 'ë‹¨ì²´', facility: 'ë¶€ëŒ€ì‹œì„¤', other: 'ê¸°íƒ€' };
            
            Object.entries(byChannel).forEach(([k, v], i) => {
                if (v > 0) {
                    labels.push(names[k] || k);
                    data.push(v);
                }
            });
            
            if (charts.channelPie) charts.channelPie.destroy();
            charts.channelPie = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{ data: data, backgroundColor: colors.slice(0, data.length), borderWidth: 2, borderColor: '#fff' }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'right' } }
                }
            });
        }
        
        function updateDashboardChart() {
            renderSalesTrendChart();
        }
        
        // ============================================================
        // KPI ë¶„ì„
        // ============================================================
        function renderKPIAnalysis() {
            const now = new Date();
            const month = now.getMonth();
            const year = now.getFullYear();
            
            const revenues = appData.sales.filter(s => {
                const d = new Date(s.date);
                return s.type === 'revenue' && d.getMonth() === month && d.getFullYear() === year;
            });
            
            const roomRevenues = revenues.filter(s => ['room', 'ota', 'direct', 'group'].includes(s.channel));
            const totalRoomRevenue = roomRevenues.reduce((sum, s) => sum + (s.amount || 0), 0);
            const totalFee = revenues.reduce((sum, s) => sum + (s.fee || 0), 0);
            const totalRevenue = revenues.reduce((sum, s) => sum + (s.amount || 0), 0);
            const roomsSold = roomRevenues.reduce((sum, s) => sum + (s.qty || 1), 0);
            
            const totalRooms = appData.hotelInfo.totalRooms || 100;
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const daysPassed = now.getDate();
            
            const revpar = totalRoomRevenue / (totalRooms * daysPassed);
            const adr = roomsSold > 0 ? totalRoomRevenue / roomsSold : 0;
            const occ = (roomsSold / (totalRooms * daysPassed)) * 100;
            const crr = totalRevenue > 0 ? (totalFee / totalRevenue * 100) : 0;
            
            document.getElementById('kpi-revpar').textContent = formatCurrency(revpar);
            document.getElementById('kpi-adr').textContent = formatCurrency(adr);
            document.getElementById('kpi-occ').textContent = formatPercent(occ);
            document.getElementById('kpi-crr').textContent = formatPercent(crr);
            
            // KPI ìš”ì•½
            const target = appData.hotelInfo.minSalesTarget || 0;
            const progress = target > 0 ? (totalRevenue / target * 100) : 0;
            
            document.getElementById('kpi-summary').innerHTML = `
                <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:15px;">
                    <div>ğŸ“Š ì´ ë§¤ì¶œ: <strong>${formatCurrency(totalRevenue)}</strong> ${target > 0 ? `(ëª©í‘œì˜ ${progress.toFixed(0)}%)` : ''}</div>
                    <div>ğŸ›ï¸ ê°ì‹¤ íŒë§¤: <strong>${roomsSold}ê°œ</strong> (${daysPassed}ì¼ê°„)</div>
                    <div>ğŸ’¸ ì´ ìˆ˜ìˆ˜ë£Œ: <strong>${formatCurrency(totalFee)}</strong></div>
                    <div>ğŸ“ˆ ì ìœ ìœ¨: <strong>${formatPercent(occ)}</strong></div>
                </div>
            `;
            
            // ê°ì‹¤ íƒ€ì…ë³„ ì„±ê³¼
            renderRoomPerformance(roomRevenues, totalRoomRevenue);
            renderChannelPerformance(revenues, totalRevenue);
        }
        
        function renderRoomPerformance(roomRevenues, total) {
            const tbody = document.getElementById('room-performance-body');
            if (!tbody) return;
            
            const byType = {};
            roomRevenues.forEach(s => {
                const type = s.roomType || 'ë¯¸ì§€ì •';
                if (!byType[type]) byType[type] = { qty: 0, amount: 0 };
                byType[type].qty += s.qty || 1;
                byType[type].amount += s.amount || 0;
            });
            
            tbody.innerHTML = Object.entries(byType).map(([type, data]) => {
                const pct = total > 0 ? (data.amount / total * 100) : 0;
                return `<tr>
                    <td>${type}</td>
                    <td>${data.qty}ê°œ</td>
                    <td>${formatCurrency(data.amount)}</td>
                    <td>${pct.toFixed(1)}%</td>
                </tr>`;
            }).join('') || '<tr><td colspan="4" style="text-align:center;">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
        }
        
        function renderChannelPerformance(revenues, total) {
            const tbody = document.getElementById('channel-performance-body');
            if (!tbody) return;
            
            const byChannel = {};
            revenues.forEach(s => {
                const ch = s.channel || 'other';
                if (!byChannel[ch]) byChannel[ch] = { amount: 0, fee: 0 };
                byChannel[ch].amount += s.amount || 0;
                byChannel[ch].fee += s.fee || 0;
            });
            
            const names = { room: 'ê°ì‹¤', ota: 'OTA', direct: 'ì§ì ‘ì˜ˆì•½', group: 'ë‹¨ì²´', facility: 'ë¶€ëŒ€ì‹œì„¤', other: 'ê¸°íƒ€' };
            
            tbody.innerHTML = Object.entries(byChannel).map(([ch, data]) => {
                const net = data.amount - data.fee;
                const pct = total > 0 ? (data.amount / total * 100) : 0;
                return `<tr>
                    <td>${names[ch] || ch}</td>
                    <td>${formatCurrency(data.amount)}</td>
                    <td>${formatCurrency(data.fee)}</td>
                    <td style="color: ${net >= 0 ? 'var(--success)' : 'var(--danger)'}; font-weight:600;">${formatCurrency(net)}</td>
                    <td>${pct.toFixed(1)}%</td>
                </tr>`;
            }).join('') || '<tr><td colspan="5" style="text-align:center;">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
        }
        // ============================================================
        // AI ì»¨ì„¤í„´íŠ¸
        // ============================================================
        function askAI(question) {
            document.getElementById('ai-question').value = question;
            submitAIQuestion();
        }
        
        function submitAIQuestion() {
            const question = document.getElementById('ai-question').value.trim();
            if (!question) { showToast('ì§ˆë¬¸ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'warning'); return; }
            
            const response = processAIQuestion(question);
            document.getElementById('ai-response').innerHTML = response;
        }
        
        function processAIQuestion(q) {
            const qLower = q.toLowerCase();
            const now = new Date();
            const month = now.getMonth();
            const year = now.getFullYear();
            
            const revenues = appData.sales.filter(s => {
                const d = new Date(s.date);
                return s.type === 'revenue' && d.getMonth() === month && d.getFullYear() === year;
            });
            const expenses = appData.sales.filter(s => {
                const d = new Date(s.date);
                return s.type === 'expense' && d.getMonth() === month && d.getFullYear() === year;
            });
            
            const totalRevenue = revenues.reduce((sum, s) => sum + (s.amount || 0), 0);
            const totalFee = revenues.reduce((sum, s) => sum + (s.fee || 0), 0);
            const totalExpense = expenses.reduce((sum, s) => sum + (s.amount || 0), 0);
            const netSales = totalRevenue - totalFee - totalExpense;
            
            const roomRevenues = revenues.filter(s => ['room', 'ota', 'direct', 'group'].includes(s.channel));
            const roomsSold = roomRevenues.reduce((sum, s) => sum + (s.qty || 1), 0);
            const totalRooms = appData.hotelInfo.totalRooms || 100;
            const daysPassed = now.getDate();
            const occ = (roomsSold / (totalRooms * daysPassed)) * 100;
            const crr = totalRevenue > 0 ? (totalFee / totalRevenue * 100) : 0;
            
            // ë§¤ì¶œ í˜„í™©
            if (qLower.includes('ë§¤ì¶œ') && (qLower.includes('í˜„í™©') || qLower.includes('ë¶„ì„'))) {
                return `ğŸ“Š <strong>ì´ë²ˆ ë‹¬ ë§¤ì¶œ í˜„í™© ë¶„ì„</strong>

ğŸ’° ì´ ë§¤ì¶œ: ${formatCurrency(totalRevenue)}
ğŸ’µ ìˆœìˆ˜ ë§¤ì¶œ: ${formatCurrency(netSales)}
ğŸ’¸ OTA ìˆ˜ìˆ˜ë£Œ: ${formatCurrency(totalFee)} (CRR: ${crr.toFixed(1)}%)
ğŸ“‰ ì´ ì§€ì¶œ: ${formatCurrency(totalExpense)}

ğŸ›ï¸ ê°ì‹¤ íŒë§¤: ${roomsSold}ê°œ (${daysPassed}ì¼ê°„)
ğŸ“ˆ ì ìœ ìœ¨: ${formatPercent(occ)}

${totalRevenue > 0 ? `âœ… í˜„ì¬ê¹Œì§€ ì–‘í˜¸í•œ ë§¤ì¶œì„ ê¸°ë¡í•˜ê³  ìˆìŠµë‹ˆë‹¤.` : `âš ï¸ ë§¤ì¶œ ë°ì´í„°ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤. ë§¤ì¶œì„ ì…ë ¥í•´ì£¼ì„¸ìš”.`}`;
            }
            
            // KPI ë¶„ì„
            if (qLower.includes('kpi') || qLower.includes('ë‹¬ì„±') || qLower.includes('ì§€í‘œ')) {
                const target = appData.hotelInfo.minSalesTarget || 0;
                const progress = target > 0 ? (totalRevenue / target * 100) : 0;
                const revpar = totalRevenue / (totalRooms * daysPassed);
                const adr = roomsSold > 0 ? (roomRevenues.reduce((sum, s) => sum + (s.amount || 0), 0) / roomsSold) : 0;
                
                return `ğŸ¯ <strong>KPI ë‹¬ì„± í˜„í™©</strong>

ğŸ“Š RevPAR: ${formatCurrency(revpar)}
ğŸ’° ADR: ${formatCurrency(adr)}
ğŸ  ì ìœ ìœ¨: ${formatPercent(occ)}
ğŸ’¸ CRR: ${formatPercent(crr)}

${target > 0 ? `ğŸ¯ ëª©í‘œ ë‹¬ì„±ë¥ : ${progress.toFixed(0)}% (${formatCurrency(totalRevenue)} / ${formatCurrency(target)})` : ''}

${progress >= 100 ? 'ğŸ‰ ëª©í‘œë¥¼ ë‹¬ì„±í–ˆìŠµë‹ˆë‹¤!' : progress >= 80 ? 'ğŸ’ª ëª©í‘œ ë‹¬ì„±ì— ê·¼ì ‘í–ˆìŠµë‹ˆë‹¤.' : 'ğŸ“ˆ ëª©í‘œ ë‹¬ì„±ì„ ìœ„í•´ ë” ë…¸ë ¥ì´ í•„ìš”í•©ë‹ˆë‹¤.'}`;
            }
            
            // ìˆ˜ìˆ˜ë£Œ ë¶„ì„
            if (qLower.includes('ìˆ˜ìˆ˜ë£Œ') || qLower.includes('crr') || qLower.includes('íš¨ìœ¨')) {
                const byChannel = {};
                revenues.forEach(s => {
                    const ch = s.channel || 'other';
                    if (!byChannel[ch]) byChannel[ch] = { amount: 0, fee: 0 };
                    byChannel[ch].amount += s.amount || 0;
                    byChannel[ch].fee += s.fee || 0;
                });
                
                let channelAnalysis = '';
                Object.entries(byChannel).forEach(([ch, data]) => {
                    if (data.amount > 0) {
                        const chCrr = (data.fee / data.amount * 100);
                        const names = { room: 'ê°ì‹¤', ota: 'OTA', direct: 'ì§ì ‘ì˜ˆì•½', group: 'ë‹¨ì²´', facility: 'ë¶€ëŒ€ì‹œì„¤', other: 'ê¸°íƒ€' };
                        channelAnalysis += `â€¢ ${names[ch] || ch}: ${formatCurrency(data.amount)} / ìˆ˜ìˆ˜ë£Œ ${formatCurrency(data.fee)} (${chCrr.toFixed(1)}%)\n`;
                    }
                });
                
                return `ğŸ’¸ <strong>ìˆ˜ìˆ˜ë£Œ íš¨ìœ¨ì„± ë¶„ì„</strong>

ğŸ“Š ì „ì²´ CRR: ${formatPercent(crr)}
ğŸ’° ì´ ìˆ˜ìˆ˜ë£Œ: ${formatCurrency(totalFee)}

<strong>ì±„ë„ë³„ í˜„í™©:</strong>
${channelAnalysis}
${crr > 15 ? 'âš ï¸ CRRì´ 15%ë¥¼ ì´ˆê³¼í•©ë‹ˆë‹¤. ì§ê±°ë˜ ë¹„ì¤‘ì„ ë†’ì´ëŠ” ê²ƒì„ ê¶Œì¥í•©ë‹ˆë‹¤.' : 'âœ… ìˆ˜ìˆ˜ë£Œ íš¨ìœ¨ì´ ì–‘í˜¸í•©ë‹ˆë‹¤.'}`;
            }
            
            // ì±„ë„ ë¶„ì„
            if (qLower.includes('ì±„ë„') || qLower.includes('ë¹„êµ')) {
                const byChannel = {};
                revenues.forEach(s => {
                    const ch = s.channel || 'other';
                    if (!byChannel[ch]) byChannel[ch] = { amount: 0, fee: 0, qty: 0 };
                    byChannel[ch].amount += s.amount || 0;
                    byChannel[ch].fee += s.fee || 0;
                    byChannel[ch].qty += s.qty || 1;
                });
                
                const sorted = Object.entries(byChannel).sort((a, b) => b[1].amount - a[1].amount);
                const names = { room: 'ê°ì‹¤', ota: 'OTA', direct: 'ì§ì ‘ì˜ˆì•½', group: 'ë‹¨ì²´', facility: 'ë¶€ëŒ€ì‹œì„¤', other: 'ê¸°íƒ€' };
                
                let analysis = '';
                sorted.forEach(([ch, data], i) => {
                    const pct = totalRevenue > 0 ? (data.amount / totalRevenue * 100) : 0;
                    analysis += `${i+1}. ${names[ch] || ch}: ${formatCurrency(data.amount)} (${pct.toFixed(1)}%) - ${data.qty}ê±´\n`;
                });
                
                return `ğŸ“ˆ <strong>ì±„ë„ë³„ ìˆ˜ìµì„± ë¶„ì„</strong>

<strong>ë§¤ì¶œ ìˆœìœ„:</strong>
${analysis}
${sorted.length > 0 ? `ğŸ† ìµœê³  ë§¤ì¶œ ì±„ë„: ${names[sorted[0][0]] || sorted[0][0]}` : ''}`;
            }
            
            // ê°œì„  ì „ëµ
            if (qLower.includes('ì „ëµ') || qLower.includes('ê°œì„ ') || qLower.includes('í–¥ìƒ')) {
                let suggestions = [];
                
                if (crr > 15) suggestions.push('ğŸ’¡ CRRì´ ë†’ìŠµë‹ˆë‹¤. ìì‚¬ í™ˆí˜ì´ì§€ ì˜ˆì•½ ìœ ë„, OTA ìˆ˜ìˆ˜ë£Œ í˜‘ìƒì„ ê³ ë ¤í•˜ì„¸ìš”.');
                if (occ < 60) suggestions.push('ğŸ’¡ ì ìœ ìœ¨ì´ ë‚®ìŠµë‹ˆë‹¤. í”„ë¡œëª¨ì…˜ ì§„í–‰, ìš”ê¸ˆ ì •ì±… ì¡°ì •ì„ ê³ ë ¤í•˜ì„¸ìš”.');
                if (totalExpense > netSales * 0.5) suggestions.push('ğŸ’¡ ì§€ì¶œ ë¹„ì¤‘ì´ ë†’ìŠµë‹ˆë‹¤. ë¹„ìš© ì ˆê° ë°©ì•ˆì„ ê²€í† í•˜ì„¸ìš”.');
                
                suggestions.push('ğŸ’¡ ê³ ê° ë¦¬ë·° ê´€ë¦¬ë¡œ OTA ìˆœìœ„ë¥¼ ë†’ì´ì„¸ìš”.');
                suggestions.push('ğŸ’¡ ë¶€ëŒ€ì‹œì„¤ ì´ìš© íŒ¨í‚¤ì§€ ìƒí’ˆì„ ê°œë°œí•˜ì„¸ìš”.');
                suggestions.push('ğŸ’¡ ë¹„ìˆ˜ê¸° ì¥ê¸°íˆ¬ìˆ™ í• ì¸ì„ ê²€í† í•˜ì„¸ìš”.');
                
                return `ğŸš€ <strong>ë§¤ì¶œ í–¥ìƒ ì „ëµ</strong>

${suggestions.join('\n\n')}

ğŸ“Š í˜„ì¬ ìƒíƒœ ìš”ì•½:
â€¢ ì ìœ ìœ¨: ${formatPercent(occ)}
â€¢ CRR: ${formatPercent(crr)}
â€¢ ìˆœìˆ˜ìµë¥ : ${totalRevenue > 0 ? formatPercent((netSales / totalRevenue) * 100) : '0%'}`;
            }
            
            return `ì§ˆë¬¸: "${q}"

ê´€ë ¨ ë°ì´í„°ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ë‹¤ìŒê³¼ ê°™ì€ ì§ˆë¬¸ì„ ì‹œë„í•´ë³´ì„¸ìš”:
â€¢ ì´ë²ˆ ë‹¬ ë§¤ì¶œ í˜„í™© ë¶„ì„í•´ì¤˜
â€¢ KPI ë‹¬ì„±ë¥  ë¶„ì„í•´ì¤˜
â€¢ ìˆ˜ìˆ˜ë£Œ íš¨ìœ¨ì„± ë¶„ì„í•´ì¤˜
â€¢ ì±„ë„ë³„ ìˆ˜ìµì„± ë¹„êµí•´ì¤˜
â€¢ ë§¤ì¶œ í–¥ìƒ ì „ëµ ì œì•ˆí•´ì¤˜`;
        }
        
        function updateAIFeeGuide() {
            const guide = document.getElementById('ai-fee-guide');
            if (!guide) return;
            
            const revenues = appData.sales.filter(s => s.type === 'revenue');
            const totalRevenue = revenues.reduce((sum, s) => sum + (s.amount || 0), 0);
            const totalFee = revenues.reduce((sum, s) => sum + (s.fee || 0), 0);
            
            if (totalRevenue < 100000) {
                guide.innerHTML = 'ë°ì´í„°ê°€ ì¶©ë¶„íˆ ì¶•ì ë˜ë©´ AI ë¶„ì„ ê²°ê³¼ê°€ í‘œì‹œë©ë‹ˆë‹¤.';
                return;
            }
            
            const crr = (totalFee / totalRevenue * 100);
            
            let html = `<strong>ğŸ“Š ì „ì²´ CRR: ${crr.toFixed(1)}%</strong><br><br>`;
            
            if (crr > 20) {
                html += `âš ï¸ <span style="color: var(--danger);">CRRì´ ë§¤ìš° ë†’ìŠµë‹ˆë‹¤.</span><br>`;
                html += `ì§ê±°ë˜ ì±„ë„ ê°•í™”ê°€ ì‹œê¸‰í•©ë‹ˆë‹¤. ìì‚¬ í™ˆí˜ì´ì§€ ì˜ˆì•½ ì‹œ íŠ¹ë³„ í˜œíƒì„ ì œê³µí•˜ì„¸ìš”.<br><br>`;
            } else if (crr > 15) {
                html += `âš¡ <span style="color: var(--warning);">CRRì´ ë‹¤ì†Œ ë†’ìŠµë‹ˆë‹¤.</span><br>`;
                html += `OTA ìˆ˜ìˆ˜ë£Œ í˜‘ìƒì„ ê³ ë ¤í•˜ê³ , ì§ê±°ë˜ ë¹„ì¤‘ì„ ëŠ˜ë ¤ë³´ì„¸ìš”.<br><br>`;
            } else {
                html += `âœ… <span style="color: var(--success);">ìˆ˜ìˆ˜ë£Œ íš¨ìœ¨ì´ ì–‘í˜¸í•©ë‹ˆë‹¤.</span><br>`;
                html += `í˜„ì¬ ìˆ˜ìˆ˜ë£Œ ìˆ˜ì¤€ì„ ìœ ì§€í•˜ë©´ì„œ ë§¤ì¶œ ì¦ëŒ€ì— ì§‘ì¤‘í•˜ì„¸ìš”.<br><br>`;
            }
            
            // OTAë³„ ë¶„ì„
            const byOta = {};
            revenues.filter(s => s.channel === 'ota').forEach(s => {
                const name = s.otaName || 'Unknown';
                if (!byOta[name]) byOta[name] = { amount: 0, fee: 0 };
                byOta[name].amount += s.amount || 0;
                byOta[name].fee += s.fee || 0;
            });
            
            if (Object.keys(byOta).length > 0) {
                html += `<strong>OTAë³„ CRR:</strong><br>`;
                Object.entries(byOta).forEach(([name, data]) => {
                    const otaCrr = data.amount > 0 ? (data.fee / data.amount * 100) : 0;
                    const color = otaCrr > 18 ? 'var(--danger)' : otaCrr > 15 ? 'var(--warning)' : 'var(--success)';
                    html += `â€¢ ${name}: <span style="color:${color}; font-weight:600;">${otaCrr.toFixed(1)}%</span><br>`;
                });
            }
            
            guide.innerHTML = html;
        }
        // ============================================================
        // ì›”ë³„ ìº˜ë¦°ë”
        // ============================================================
        function renderMonthlyCalendar() {
            const grid = document.getElementById('monthly-calendar-grid');
            const title = document.getElementById('calendar-title');
            if (!grid || !title) return;
            
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();
            
            title.textContent = `${year}ë…„ ${month + 1}ì›”`;
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDayOfWeek = firstDay.getDay();
            
            // ì›”ë³„ ë°ì´í„° ì§‘ê³„
            const dailyData = {};
            appData.sales.forEach(s => {
                const d = new Date(s.date);
                if (d.getMonth() === month && d.getFullYear() === year) {
                    const day = d.getDate();
                    if (!dailyData[day]) dailyData[day] = { revenue: 0, expense: 0 };
                    if (s.type === 'revenue') dailyData[day].revenue += s.amount || 0;
                    else if (s.type === 'expense') dailyData[day].expense += s.amount || 0;
                }
            });
            
            let html = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '].map(d => 
                `<div style="text-align:center; font-weight:600; padding:10px; background:var(--gray-100); border-radius:6px;">${d}</div>`
            ).join('');
            
            for (let i = 0; i < startDayOfWeek; i++) {
                html += '<div style="min-height:80px;"></div>';
            }
            
            for (let day = 1; day <= lastDay.getDate(); day++) {
                const data = dailyData[day] || { revenue: 0, expense: 0 };
                const net = data.revenue - data.expense;
                const hasData = data.revenue > 0 || data.expense > 0;
                
                html += `
                    <div style="min-height:80px; padding:8px; border:1px solid var(--gray-200); border-radius:8px; ${hasData ? 'background:var(--gray-100);' : ''}">
                        <div style="font-weight:600; margin-bottom:5px;">${day}</div>
                        ${hasData ? `
                            <div style="font-size:0.7rem; line-height:1.4;">
                                ${data.revenue > 0 ? `<div style="color:var(--primary);">+${(data.revenue/10000).toFixed(0)}ë§Œ</div>` : ''}
                                ${data.expense > 0 ? `<div style="color:var(--danger);">-${(data.expense/10000).toFixed(0)}ë§Œ</div>` : ''}
                            </div>
                        ` : ''}
                    </div>
                `;
            }
            
            grid.innerHTML = html;
            
            // ì›”ê°„ ìš”ì•½
            const summary = document.getElementById('monthly-summary');
            if (summary) {
                const totalRev = Object.values(dailyData).reduce((sum, d) => sum + d.revenue, 0);
                const totalExp = Object.values(dailyData).reduce((sum, d) => sum + d.expense, 0);
                summary.innerHTML = `
                    <div style="display:grid; gap:10px;">
                        <div>ğŸ“ˆ ì´ ë§¤ì¶œ: <strong style="color:var(--primary);">${formatCurrency(totalRev)}</strong></div>
                        <div>ğŸ“‰ ì´ ì§€ì¶œ: <strong style="color:var(--danger);">${formatCurrency(totalExp)}</strong></div>
                        <div>ğŸ’° ìˆœì´ìµ: <strong style="color:${totalRev-totalExp >= 0 ? 'var(--success)' : 'var(--danger)'};">${formatCurrency(totalRev - totalExp)}</strong></div>
                    </div>
                `;
            }
        }
        
        function changeCalendarMonth(delta) {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + delta);
            renderMonthlyCalendar();
        }
        
        // ============================================================
        // í”„ë¡œëª¨ì…˜
        // ============================================================
        async function addPromotion() {
            if (!currentTenant?.id) return;
            
            const name = document.getElementById('promo-name').value.trim();
            const start = document.getElementById('promo-start').value;
            const end = document.getElementById('promo-end').value;
            const discount = parseFloat(document.getElementById('promo-discount').value) || 0;
            const channel = document.getElementById('promo-channel').value;
            const memo = document.getElementById('promo-memo').value;
            
            if (!name || !start || !end) {
                showToast('í•„ìˆ˜ í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'warning');
                return;
            }
            
            try {
                await db.collection('tenants').doc(currentTenant.id).collection('promotions').add({
                    name, start, end, discount, channel, memo,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                showToast('í”„ë¡œëª¨ì…˜ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                
                document.getElementById('promo-name').value = '';
                document.getElementById('promo-start').value = '';
                document.getElementById('promo-end').value = '';
                document.getElementById('promo-discount').value = '';
                document.getElementById('promo-memo').value = '';
            } catch (err) {
                showToast('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }
        
        function renderPromotionList() {
            const tbody = document.getElementById('promo-list-body');
            if (!tbody) return;
            
            const today = new Date().toISOString().split('T')[0];
            const channels = { all: 'ì „ì²´', ota: 'OTA', direct: 'ì§ì ‘ì˜ˆì•½' };
            
            tbody.innerHTML = appData.promotions.map(p => {
                let status, statusColor;
                if (today < p.start) { status = 'ì˜ˆì •'; statusColor = 'var(--warning)'; }
                else if (today > p.end) { status = 'ì¢…ë£Œ'; statusColor = 'var(--text-muted)'; }
                else { status = 'ì§„í–‰ì¤‘'; statusColor = 'var(--success)'; }
                
                return `<tr>
                    <td>${p.name}</td>
                    <td>${p.start} ~ ${p.end}</td>
                    <td>${p.discount}%</td>
                    <td>${channels[p.channel] || p.channel}</td>
                    <td><span style="color:${statusColor}; font-weight:600;">${status}</span></td>
                    <td><button class="btn btn-danger" style="padding:5px 10px; font-size:0.8rem;" onclick="deletePromotion('${p.id}')">ì‚­ì œ</button></td>
                </tr>`;
            }).join('') || '<tr><td colspan="6" style="text-align:center;">ë“±ë¡ëœ í”„ë¡œëª¨ì…˜ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
        }
        
        async function deletePromotion(id) {
            if (!confirm('ì´ í”„ë¡œëª¨ì…˜ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            try {
                await db.collection('tenants').doc(currentTenant.id).collection('promotions').doc(id).delete();
                showToast('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            } catch (err) {
                showToast('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }
        
        function renderPromoCalendar() {
            // ê°„ë‹¨í•œ í”„ë¡œëª¨ì…˜ ìº˜ë¦°ë”
            const container = document.getElementById('promo-calendar');
            if (!container) return;
            
            const today = new Date();
            const promos = appData.promotions.filter(p => new Date(p.end) >= today);
            
            if (promos.length === 0) {
                container.innerHTML = '<p style="text-align:center; color:var(--text-muted);">ì˜ˆì •ëœ í”„ë¡œëª¨ì…˜ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }
            
            container.innerHTML = promos.map(p => `
                <div style="padding:10px; margin-bottom:8px; background:var(--gray-100); border-radius:8px; border-left:4px solid var(--primary);">
                    <div style="font-weight:600;">${p.name}</div>
                    <div style="font-size:0.8rem; color:var(--text-muted);">${p.start} ~ ${p.end} / ${p.discount}% í• ì¸</div>
                </div>
            `).join('');
        }
        
        // ============================================================
        // ì‚¬ìš©ì ê´€ë¦¬ (ê´€ë¦¬ì)
        // ============================================================
        function renderUsersList(users) {
            const tbody = document.getElementById('users-list-body');
            if (!tbody) return;
            
            tbody.innerHTML = users.map(u => {
                const date = u.createdAt?.toDate ? u.createdAt.toDate().toLocaleDateString('ko-KR') : '-';
                const roleText = u.role === 'admin' ? 'ê´€ë¦¬ì' : 'ì§ì›';
                const statusText = u.status === 'active' ? 'í™œì„±' : 'ë¹„í™œì„±';
                
                return `<tr>
                    <td>${u.name || '-'}</td>
                    <td>${u.email}</td>
                    <td><span style="color: ${u.role === 'admin' ? 'var(--primary)' : 'var(--text-muted)'}; font-weight:600;">${roleText}</span></td>
                    <td>${date}</td>
                    <td>${statusText}</td>
                    <td>${u.role !== 'admin' && currentUserRole === 'admin' ? 
                        `<button class="btn btn-danger" style="padding:4px 8px; font-size:0.75rem;" onclick="removeUser('${u.id}')">ì œê±°</button>` : '-'}</td>
                </tr>`;
            }).join('') || '<tr><td colspan="6" style="text-align:center;">ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
        }
        
        async function removeUser(userId) {
            if (!confirm('ì´ ì‚¬ìš©ìë¥¼ ì œê±°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            try {
                await db.collection('users').doc(userId).update({ status: 'inactive', tenantId: null });
                showToast('ì‚¬ìš©ìê°€ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            } catch (err) {
                showToast('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }
        
        // ============================================================
        // ë³´ê³ ì„œ
        // ============================================================
        function generateReport() {
            const type = document.getElementById('report-type').value;
            const date = new Date(document.getElementById('report-date').value || new Date());
            const preview = document.getElementById('report-preview');
            
            let periodName, startDate, endDate;
            if (type === 'monthly') {
                periodName = `${date.getFullYear()}ë…„ ${date.getMonth() + 1}ì›”`;
                startDate = new Date(date.getFullYear(), date.getMonth(), 1);
                endDate = new Date(date.getFullYear(), date.getMonth() + 1, 0);
            } else if (type === 'quarterly') {
                const q = Math.floor(date.getMonth() / 3);
                periodName = `${date.getFullYear()}ë…„ ${q + 1}ë¶„ê¸°`;
                startDate = new Date(date.getFullYear(), q * 3, 1);
                endDate = new Date(date.getFullYear(), q * 3 + 3, 0);
            } else {
                periodName = `${date.getFullYear()}ë…„`;
                startDate = new Date(date.getFullYear(), 0, 1);
                endDate = new Date(date.getFullYear(), 11, 31);
            }
            
            const periodSales = appData.sales.filter(s => {
                const d = new Date(s.date);
                return d >= startDate && d <= endDate;
            });
            
            const revenues = periodSales.filter(s => s.type === 'revenue');
            const expenses = periodSales.filter(s => s.type === 'expense');
            
            const totalRevenue = revenues.reduce((sum, s) => sum + (s.amount || 0), 0);
            const totalFee = revenues.reduce((sum, s) => sum + (s.fee || 0), 0);
            const totalExpense = expenses.reduce((sum, s) => sum + (s.amount || 0), 0);
            const netSales = totalRevenue - totalFee - totalExpense;
            
            preview.innerHTML = `
                <div style="padding:30px;">
                    <div style="text-align:center; margin-bottom:30px; padding-bottom:20px; border-bottom:3px solid var(--primary);">
                        <img src="https://i.ibb.co/spPvbV5T/Hotel-Care-25.png" style="max-width:80px; margin-bottom:10px;">
                        <h2 style="color:var(--dark); margin-bottom:5px;">${appData.hotelInfo.name || 'HotelCare25'}</h2>
                        <h3 style="color:var(--primary);">${periodName} ë³´ê³ ì„œ</h3>
                        <p style="color:var(--text-muted); font-size:0.85rem;">ìƒì„±ì¼: ${new Date().toLocaleDateString('ko-KR')}</p>
                    </div>
                    
                    <h4 style="color:var(--primary); margin:20px 0 15px; border-bottom:1px solid var(--gray-200); padding-bottom:8px;">1. ë§¤ì¶œ ìš”ì•½</h4>
                    <table style="width:100%; margin-bottom:25px;">
                        <tr><td>ì „ì²´ ë§¤ì¶œ</td><td style="text-align:right; font-weight:600;">${formatCurrency(totalRevenue)}</td></tr>
                        <tr><td>OTA ìˆ˜ìˆ˜ë£Œ</td><td style="text-align:right;">${formatCurrency(totalFee)}</td></tr>
                        <tr><td>ì´ ì§€ì¶œ</td><td style="text-align:right;">${formatCurrency(totalExpense)}</td></tr>
                        <tr style="border-top:2px solid var(--dark);"><td><strong>ìˆœì´ìµ</strong></td><td style="text-align:right; font-weight:700; color:${netSales >= 0 ? 'var(--success)' : 'var(--danger)'};">${formatCurrency(netSales)}</td></tr>
                    </table>
                    
                    <h4 style="color:var(--primary); margin:20px 0 15px; border-bottom:1px solid var(--gray-200); padding-bottom:8px;">2. í•µì‹¬ ì§€í‘œ</h4>
                    <div style="display:grid; grid-template-columns: repeat(2, 1fr); gap:15px; margin-bottom:25px;">
                        <div style="background:var(--gray-100); padding:15px; border-radius:8px;">
                            <div style="font-size:0.85rem; color:var(--text-muted);">CRR (ìˆ˜ìˆ˜ë£Œìœ¨)</div>
                            <div style="font-size:1.3rem; font-weight:700;">${totalRevenue > 0 ? formatPercent(totalFee/totalRevenue*100) : '0%'}</div>
                        </div>
                        <div style="background:var(--gray-100); padding:15px; border-radius:8px;">
                            <div style="font-size:0.85rem; color:var(--text-muted);">ìˆœì´ìµë¥ </div>
                            <div style="font-size:1.3rem; font-weight:700;">${totalRevenue > 0 ? formatPercent(netSales/totalRevenue*100) : '0%'}</div>
                        </div>
                    </div>
                    
                    <p style="text-align:center; color:var(--text-muted); font-size:0.8rem; margin-top:30px;">
                        HotelCare25 Revenue Manager - Powered by IMS UNION
                    </p>
                </div>
            `;
        }
        
        function printReport() {
            window.print();
        }
        
        // ============================================================
        // ì„¤ì • ë° ë°ì´í„° ê´€ë¦¬
        // ============================================================
        function exportData() {
            const data = {
                hotelInfo: appData.hotelInfo,
                sales: appData.sales,
                otas: appData.otas,
                promotions: appData.promotions,
                exportDate: new Date().toISOString(),
                tenantName: currentTenant?.name
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `hotelcare25_backup_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            showToast('ë°ì´í„°ê°€ ë‚´ë³´ë‚´ê¸°ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
        }
        
        async function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (data.hotelInfo) {
                        await db.collection('tenants').doc(currentTenant.id)
                            .collection('data').doc('hotelInfo').set(data.hotelInfo, { merge: true });
                    }
                    
                    showToast('ë°ì´í„°ë¥¼ ê°€ì ¸ì™”ìŠµë‹ˆë‹¤. ë§¤ì¶œ/OTA ë°ì´í„°ëŠ” ìˆ˜ë™ìœ¼ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'success');
                } catch (err) {
                    showToast('íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                }
            };
            reader.readAsText(file);
        }
        
        function confirmClearData() {
            showModal('ë°ì´í„° ì´ˆê¸°í™”', `
                <p style="line-height:1.6;">ì •ë§ë¡œ ëª¨ë“  ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
                <p style="color:var(--danger); font-weight:600; margin-top:10px;">âš ï¸ ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
            `, `
                <button class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
                <button class="btn btn-danger" onclick="clearAllData()">ì´ˆê¸°í™”</button>
            `);
        }
        
        async function clearAllData() {
            if (!currentTenant?.id) return;
            
            try {
                // ë§¤ì¶œ ë°ì´í„° ì‚­ì œ
                const salesSnapshot = await db.collection('tenants').doc(currentTenant.id).collection('sales').get();
                const batch = db.batch();
                salesSnapshot.docs.forEach(doc => batch.delete(doc.ref));
                await batch.commit();
                
                showToast('ë°ì´í„°ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                closeModal();
            } catch (err) {
                showToast('ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }
        
        function renderCRRChart() {
            const canvas = document.getElementById('crr-chart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            const otaData = [];
            appData.otas.forEach(ota => {
                const sales = appData.sales.filter(s => s.type === 'revenue' && s.otaName === ota.name);
                const total = sales.reduce((sum, s) => sum + (s.amount || 0), 0);
                const fee = sales.reduce((sum, s) => sum + (s.fee || 0), 0);
                const actualCRR = total > 0 ? (fee / total * 100) : 0;
                otaData.push({ name: ota.name, target: ota.feeRate, actual: actualCRR });
            });
            
            if (charts.crr) charts.crr.destroy();
            charts.crr = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: otaData.map(d => d.name),
                    datasets: [
                        { label: 'ê¸°ì¤€ CRR', data: otaData.map(d => d.target), backgroundColor: 'rgba(148,163,184,0.7)' },
                        { label: 'ì‹¤ì œ CRR', data: otaData.map(d => d.actual), backgroundColor: otaData.map(d => d.actual > d.target ? 'rgba(239,68,68,0.7)' : 'rgba(16,185,129,0.7)') }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true, max: 30, ticks: { callback: v => v + '%' } } }
                }
            });
        }
        
        function showNotification() {
            showToast('ìƒˆë¡œìš´ ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.', 'info');
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ Firebase ì„¤ì • í™•ì¸
        window.addEventListener('load', () => {
            if (firebaseConfig.apiKey === 'YOUR_API_KEY') {
                document.getElementById('auth-error').textContent = 'âš ï¸ Firebase ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤. ì½”ë“œ ìƒë‹¨ì˜ firebaseConfigë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”.';
                document.getElementById('auth-error').classList.add('show');
                document.getElementById('login-btn').disabled = true;
                document.getElementById('register-btn').disabled = true;
            }
        });
    </script>
</body>
</html>
